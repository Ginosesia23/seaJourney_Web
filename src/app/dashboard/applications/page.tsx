'use client';

import React, { useState, useMemo, useEffect, useRef } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { format, startOfDay, isAfter, parse, eachDayOfInterval, isWithinInterval, subMonths, addDays, differenceInDays } from 'date-fns';
import { LifeBuoy, Loader2, PlusCircle, Mail, Calendar, CalendarIcon, Ship, Clock, CheckCircle2, XCircle, FileText, Download, Trash2, AlertCircle, ChevronDown, ChevronUp, Lock, Navigation, Award, FileCheck, Info, Sparkles } from 'lucide-react';
import Link from 'next/link';

import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { SearchableSelect } from '@/components/ui/searchable-select';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Calendar as CalendarComponent } from '@/components/ui/calendar';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from '@/components/ui/dialog';
import { Textarea } from '@/components/ui/textarea';
import { SignaturePad } from '@/components/signature-pad';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { useUser, useSupabase } from '@/supabase';
import { useCollection, useDoc } from '@/supabase/database';
import { getVesselStateLogs, getVesselAssignments } from '@/supabase/database/queries';
import { calculateStandbyDays } from '@/lib/standby-calculation';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { generateTestimonialPDF, generateNavWatchApplicationPDF, generateMCAWatchRatingForm, generateMCAOOWForm_MSF_4274, type TestimonialPDFFormat } from '@/lib/pdf-generator';
// testimonial_code is now auto-generated by database trigger when testimonial is approved
import type { Vessel, UserProfile, Testimonial, TestimonialStatus, VesselAssignment, NavWatchApplication } from '@/lib/types';
import type { StateLog } from '@/lib/types';
import type { SupabaseClient } from '@supabase/supabase-js';

const testimonialSchema = z.object({
  vessel_id: z.string().min(1, 'Please select a vessel.'),
  start_date: z.date({ required_error: 'A start date is required.' }),
  end_date: z.date({ required_error: 'An end date is required.' }),
  captain_email: z.string().email('Please enter a valid email address.').optional().or(z.literal('')),
  captain_name: z.string().optional(),
  official_body: z.string().optional(),
  official_reference: z.string().optional(),
  notes: z.string().optional(),
}).refine((data) => {
  if (data.end_date && data.end_date < data.start_date) {
    return false;
  }
  return true;
}, {
  message: "End date must be after start date",
  path: ["end_date"],
}).refine((data) => {
  const today = startOfDay(new Date());
  const startDate = startOfDay(data.start_date);
  const endDate = startOfDay(data.end_date);
  
  if (isAfter(startDate, today) || isAfter(endDate, today)) {
    return false;
  }
  return true;
}, {
  message: "Dates cannot be in the future",
  path: ["end_date"],
});

type TestimonialFormValues = z.infer<typeof testimonialSchema>;

// Nav Watch Application Schema - automatically includes all sea time from all vessels
const navWatchApplicationSchema = z.object({
  certificate_type: z.enum(['navigational_ii4', 'navigational_iii4', 'electro_technical'], {
    required_error: 'Please select a certificate type.',
  }),
  // Section 4: Checklist (for Navigational and Engine Room)
  checklist: z.object({
    attestedPassport: z.boolean().optional(),
    payment: z.boolean().optional(),
    dischargeBookOrCd: z.boolean().optional(),
    seaServiceTestimonials: z.boolean().optional(),
    passportPhoto: z.boolean().optional(),
    stcwBasicTraining: z.boolean().optional(),
    securityAwareness: z.boolean().optional(),
    profInSurvivalCraft: z.boolean().optional(),
    medical: z.boolean().optional(),
    watchRatingTrainingRecordBook: z.boolean().optional(),
    mntb: z.boolean().optional(),
  }).optional(),
  // Section 5: ETR Checklist (for Electro-technical only)
  checklistETR: z.object({
    attestedPassport: z.boolean().optional(),
    payment: z.boolean().optional(),
    dischargeBookOrCd: z.boolean().optional(),
    seaServiceTestimonials: z.boolean().optional(),
    passportPhoto: z.boolean().optional(),
    stcwBasicTraining: z.boolean().optional(),
    securityAwareness: z.boolean().optional(),
    electroTechnicalTraining: z.boolean().optional(),
    medical: z.boolean().optional(),
    electroTechnicalRecordBook: z.boolean().optional(),
  }).optional(),
  // Include countersign checkbox (for all certificate types)
  includeCountersign: z.boolean().optional(),
  // Section 7: Countersign (available for all certificate types when checkbox is checked)
  counterSign: z.object({
    name: z.string().optional(),
    addressLine1: z.string().optional(),
    addressLine2: z.string().optional(),
    townCity: z.string().optional(),
    countyState: z.string().optional(),
    postCode: z.string().optional(),
    country: z.string().optional(),
    telephone: z.string().optional(),
    occupation: z.string().optional(),
    capacityKnownApplicant: z.string().optional(),
    date: z.string().optional(),
  }).optional(),
  // Section 6: Declaration signature
  signatureDataUrl: z.string().optional(),
  watchkeeping_hours: z.number().min(0, 'Watchkeeping hours must be positive').optional(),
});

type NavWatchApplicationFormValues = z.infer<typeof navWatchApplicationSchema>;

// OOW Application Schema
const oowApplicationSchema = z.object({
  certificate_type: z.enum([
    'ii3_oow_lt500gt_d',
    'ii3_oow_lt500gt_nc',
    'ii1_oow_unlimited',
    'ii2_cm_lt3000gt_nc',
    'ii2_cm_lt3000gt_unlimited',
    'ii2_cm_unlimited_nc',
    'ii2_cm_unlimited_unlimited',
    'ii3_master_lt500gt_d',
    'ii3_master_lt500gt_nc',
    'ii2_master_lt3000gt_specified',
    'ii2_master_lt3000gt_unlimited',
    'ii2_master_unlimited_nc',
    'ii2_master_unlimited_unlimited',
  ], {
    required_error: 'Please select a certificate type.',
  }),
  // Declaration signature
  signatureDataUrl: z.string().optional(),
});

type OOWApplicationFormValues = z.infer<typeof oowApplicationSchema>;

const APP_URL = process.env.NEXT_PUBLIC_APP_URL || 'http://www.seajourney.co.uk';

// Helper function to create or get a secure signoff token
async function createOrGetSignoffToken(
  supabase: SupabaseClient,
  testimonialId: string,
  captainEmail: string
): Promise<string> {
  // 1. Try to reuse a valid token if it exists
  const { data: existing, error: existingError } = await supabase
    .from('testimonials')
    .select('signoff_token, signoff_token_expires_at, signoff_target_email')
    .eq('id', testimonialId)
    .maybeSingle();

  if (existingError) {
    console.error('Error checking existing token:', existingError);
    throw existingError;
  }

  const now = new Date();

  if (
    existing?.signoff_token &&
    existing.signoff_token_expires_at &&
    existing.signoff_target_email === captainEmail &&
    new Date(existing.signoff_token_expires_at) > now
  ) {
    return existing.signoff_token as string;
  }

  // 2. Otherwise, create a new one
  const token = crypto.randomUUID(); // browser-safe in Next.js

  const expiresAt = new Date();
  expiresAt.setDate(expiresAt.getDate() + 7); // 7 days validity

  const { error: updateError } = await supabase
    .from('testimonials')
    .update({
      signoff_token: token,
      signoff_token_expires_at: expiresAt.toISOString(),
      signoff_target_email: captainEmail,
    })
    .eq('id', testimonialId);

  if (updateError) {
    console.error('Error creating signoff token:', updateError);
    throw updateError;
  }

  return token;
}

// Helper function to request captain signoff
async function requestCaptainSignoff(
  supabase: SupabaseClient,
  testimonial: Testimonial & { vessel_name?: string },
  toast: (props: { title: string; description: string; variant?: 'default' | 'destructive' }) => void
): Promise<void> {
  if (!testimonial.captain_email) {
    throw new Error('Captain email is required');
  }

  const captainEmail = testimonial.captain_email;
  const captainName = testimonial.captain_name || 'Captain';
  const vesselName = testimonial.vessel_name ?? 'Your Vessel';

  // 1. Ensure token is in DB
  const token = await createOrGetSignoffToken(
    supabase,
    testimonial.id,
    captainEmail
  );

  // 2. Build the link used in the email
  const signoffLink = `${APP_URL}/testimonials/signoff?token=${encodeURIComponent(
    token
  )}&email=${encodeURIComponent(captainEmail)}`;

  // 3. Call Edge Function
  const { data, error } = await supabase.functions.invoke('send-signoff-request', {
    body: {
      captainEmail,
      captainName,
      vesselName,
      signoffLink,
      pdfUrl: testimonial.pdf_url || null,
    },
  });

  if (error) {
    console.error('Error sending email:', error);
    
    // Try to get more details from the response
    if (error.context instanceof Response) {
      try {
        const errorText = await error.context.clone().text();
        console.error('Edge Function error response body:', errorText);
        try {
          const errorJson = JSON.parse(errorText);
          console.error('Edge Function error details:', errorJson);
        } catch {
          // Not JSON, that's fine
        }
      } catch (e) {
        console.error('Could not read error response body:', e);
      }
    }
    
    const statusCode = error.context?.status || error.status;
    const errorMessage = error.message || 'Unknown error';
    const isNetworkError = errorMessage?.includes('Failed to fetch') || 
                          errorMessage?.includes('Failed to send a request');
    
    let errorDescription = '';
    if (isNetworkError) {
      errorDescription = `Email function appears to be unavailable. Please verify the Edge Function 'send-signoff-request' is deployed in Supabase.`;
    } else if (statusCode === 400) {
      errorDescription = `The email request was invalid (Status: ${statusCode}). Please check the console for details and contact the captain manually.`;
    } else {
      errorDescription = statusCode 
        ? `Email failed (Status: ${statusCode}): ${errorMessage}. Please contact the captain manually.`
        : errorMessage 
          ? `Email failed: ${errorMessage}. Please contact the captain manually.`
          : `There was an error sending the email. Please contact the captain manually.`;
    }
    
    toast({
      title: 'Request Created',
      description: errorDescription,
      variant: statusCode === 400 ? 'destructive' : 'default',
    });
    
    return;
  }

  // 4. Optionally update status to pending_captain
  await supabase
    .from('testimonials')
    .update({ status: 'pending_captain' })
    .eq('id', testimonial.id);

  // 5. Show success toast
  toast({
    title: 'Request Sent',
    description: `Testimonial request has been sent to ${captainEmail}. You will be notified when the captain responds.`,
  });
}

// Helper function to calculate day counts from state logs for a date range
function calculateDayCounts(stateLogs: StateLog[], startDate: string, endDate: string) {
  const start = parse(startDate, 'yyyy-MM-dd', new Date());
  const end = parse(endDate, 'yyyy-MM-dd', new Date());
  
  console.log('[calculateDayCounts] Input:', {
    totalLogs: stateLogs.length,
    startDate,
    endDate,
    firstFewLogs: stateLogs.slice(0, 5).map(l => ({ date: l.date, state: l.state }))
  });
  
  // Filter logs to the date range (inclusive)
  const rangeLogs = stateLogs.filter(log => {
    const logDate = parse(log.date, 'yyyy-MM-dd', new Date());
    const isInRange = logDate >= start && logDate <= end;
    return isInRange;
  });
  
  console.log('[calculateDayCounts] Filtered logs in range:', {
    totalInRange: rangeLogs.length,
    firstFewInRange: rangeLogs.slice(0, 5).map(l => ({ date: l.date, state: l.state }))
  });
  
  // Extract part of active passage dates from logs
  const partOfActivePassageDates = new Set<string>();
  rangeLogs.forEach(log => {
    if (log.isPartOfActivePassage) {
      partOfActivePassageDates.add(log.date);
    }
  });
  
  // Calculate standby days using the standby calculation function
  // Pass part of active passage dates so they're counted as "at sea"
  const { totalStandbyDays, totalSeaDays } = calculateStandbyDays(rangeLogs, undefined, partOfActivePassageDates);
  const standbyDays = totalStandbyDays;
  
  // At sea = underway days + part of active passage days
  // Note: at-anchor days are NOT counted unless marked as part of active passage
  const atSeaDays = totalSeaDays;
  const yardDays = rangeLogs.filter(log => log.state === 'in-yard').length;
  const leaveDays = rangeLogs.filter(log => log.state === 'on-leave').length;
  
  // Calculate total days as the sum to satisfy the database constraint
  // The constraint likely requires: total_days = at_sea_days + standby_days + yard_days + leave_days
  const totalDays = atSeaDays + standbyDays + yardDays + leaveDays;
  
  const result = {
    total_days: totalDays,
    at_sea_days: atSeaDays,
    standby_days: standbyDays,
    yard_days: yardDays,
    leave_days: leaveDays,
  };
  
  console.log('[calculateDayCounts] Result:', result);
  
  return result;
}

export type DocumentType = 'testimonial' | 'nav_watch_application' | 'oow' | 'custom';

interface DocumentTypeConfig {
  id: DocumentType;
  label: string;
  description: string;
  icon: React.ComponentType<{ className?: string }>;
  available: boolean;
}

const DOCUMENT_TYPES: DocumentTypeConfig[] = [
  {
    id: 'testimonial',
    label: 'Testimonial',
    description: 'Sea service testimonials from vessel captains',
    icon: FileText,
    available: true,
  },
  {
    id: 'nav_watch_application',
    label: 'Nav Watch Application',
    description: 'Navigation watch application forms',
    icon: Navigation,
    available: true, // Now implemented
  },
  {
    id: 'oow',
    label: 'OOW Application',
    description: 'Officer of the Watch application documents',
    icon: Award,
    available: true, // Now implemented
  },
  {
    id: 'custom',
    label: 'Custom Document',
    description: 'Create custom maritime documents',
    icon: FileCheck,
    available: false, // Will be implemented
  },
];

export default function ApplicationsPage() {
  const [documentType, setDocumentType] = useState<DocumentType>('testimonial');
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [isNavWatchDialogOpen, setIsNavWatchDialogOpen] = useState(false);
  const [isOowDialogOpen, setIsOowDialogOpen] = useState(false);
  const [expandedTestimonials, setExpandedTestimonials] = useState<Set<string>>(new Set());
  const [isSaving, setIsSaving] = useState(false);
  const [testimonials, setTestimonials] = useState<Testimonial[]>([]);
  const [isLoadingTestimonials, setIsLoadingTestimonials] = useState(false);
  const [navWatchApplications, setNavWatchApplications] = useState<NavWatchApplication[]>([]);
  const [isLoadingNavWatchApplications, setIsLoadingNavWatchApplications] = useState(false);
  const [applicationToDelete, setApplicationToDelete] = useState<NavWatchApplication | null>(null);
  const [isDeletingApplication, setIsDeletingApplication] = useState(false);
  const [activeTab, setActiveTab] = useState<'all' | 'draft' | 'pending' | 'approved' | 'rejected'>('all');
  const [selectedVesselLogs, setSelectedVesselLogs] = useState<StateLog[]>([]);
  const [testimonialToDelete, setTestimonialToDelete] = useState<Testimonial | null>(null);
  const [deletePassword, setDeletePassword] = useState('');
  const [passwordError, setPasswordError] = useState('');
  const [isVerifyingPassword, setIsVerifyingPassword] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const isVerifyingRef = useRef(false);

    const { user } = useUser();
  const { supabase } = useSupabase();
  const { toast } = useToast();

  const form = useForm<TestimonialFormValues>({
    resolver: zodResolver(testimonialSchema),
    defaultValues: {
      vessel_id: '',
      captain_email: '',
      captain_name: '',
      official_body: '',
      official_reference: '',
      notes: '',
    },
    mode: 'onChange',
  });

  const navWatchForm = useForm<NavWatchApplicationFormValues>({
    resolver: zodResolver(navWatchApplicationSchema),
    defaultValues: {
      certificate_type: 'navigational_ii4',
      checklist: {
        attestedPassport: false,
        payment: false,
        dischargeBookOrCd: false,
        seaServiceTestimonials: false,
        passportPhoto: false,
        stcwBasicTraining: false,
        securityAwareness: false,
        profInSurvivalCraft: false,
        medical: false,
        watchRatingTrainingRecordBook: false,
        mntb: false,
      },
      checklistETR: {
        attestedPassport: false,
        payment: false,
        dischargeBookOrCd: false,
        seaServiceTestimonials: false,
        passportPhoto: false,
        stcwBasicTraining: false,
        securityAwareness: false,
        electroTechnicalTraining: false,
        medical: false,
        electroTechnicalRecordBook: false,
      },
      includeCountersign: false,
      counterSign: undefined,
      signatureDataUrl: undefined,
      watchkeeping_hours: undefined,
    },
    mode: 'onChange',
  });

  const oowForm = useForm<OOWApplicationFormValues>({
    resolver: zodResolver(oowApplicationSchema),
    defaultValues: {
      certificate_type: undefined,
      signatureDataUrl: undefined,
    },
    mode: 'onChange',
  });

  // State to track if user wants to select a different vessel
  const [useDifferentVessel, setUseDifferentVessel] = useState(false);

  // Watch vessel_id and date range to calculate day counts
  const watchedVesselId = form.watch('vessel_id');
  const watchedStartDate = form.watch('start_date');
  const watchedEndDate = form.watch('end_date');
  
  // Track active captain for selected vessel (just the ID - profile fetched in inbox)
  const [activeCaptain, setActiveCaptain] = useState<{ id: string } | null>(null);
  const [isCheckingCaptain, setIsCheckingCaptain] = useState(false);
  // Track all active captains with their profiles
  const [availableCaptains, setAvailableCaptains] = useState<Array<{
    id: string;
    isPrimary: boolean;
    name?: string;
    email?: string;
    onboard?: boolean;
  }>>([]);

  // Fetch user profile
  const { data: userProfileRaw, isLoading: isLoadingProfile } = useDoc<UserProfile>('users', user?.id);
  
  const userProfile = useMemo(() => {
    if (!userProfileRaw) return null;
    const role = (userProfileRaw as any).role || userProfileRaw.role || 'crew';
    const subscriptionTier = (userProfileRaw as any).subscription_tier || userProfileRaw.subscriptionTier || 'free';
    const subscriptionStatus = (userProfileRaw as any).subscription_status || userProfileRaw.subscriptionStatus || 'inactive';
    return {
      ...userProfileRaw,
      id: userProfileRaw.id,
      email: (userProfileRaw as any).email || '',
      username: (userProfileRaw as any).username || '',
      activeVesselId: (userProfileRaw as any).active_vessel_id || (userProfileRaw as any).activeVesselId || undefined,
      firstName: (userProfileRaw as any).first_name || (userProfileRaw as any).firstName,
      lastName: (userProfileRaw as any).last_name || (userProfileRaw as any).lastName,
      role: role,
      subscriptionTier: subscriptionTier,
      subscriptionStatus: subscriptionStatus,
    } as UserProfile;
  }, [userProfileRaw]);

  // Check if user has premium access (for Nav Watch and OOW applications)
  const hasPremiumAccess = useMemo(() => {
    if (!userProfile) return false;
    const tier = (userProfile as any).subscription_tier || userProfile.subscriptionTier || 'free';
    const status = (userProfile as any).subscription_status || userProfile.subscriptionStatus || 'inactive';
    const role = (userProfile as any).role || userProfile.role || 'crew';
    
    // Vessel accounts: allow all active vessel tiers
    if (role === 'vessel') {
      const tierLower = tier.toLowerCase();
      return (tierLower.startsWith('vessel_') || tierLower === 'vessel_lite' || tierLower === 'vessel_basic' || tierLower === 'vessel_pro' || tierLower === 'vessel_fleet') && status === 'active';
    }
    
    // Crew accounts: premium or pro only
    return (tier === 'premium' || tier === 'pro') && status === 'active';
  }, [userProfile]);

  // Note: Applications page is accessible to all users for testimonials
  // Nav Watch and OOW applications are restricted to premium users (handled in their respective sections)

  // Query all vessels
  const { data: allVessels, isLoading: isLoadingVessels } = useCollection<Vessel>(
    user?.id ? 'vessels' : null,
    user?.id ? { orderBy: 'created_at', ascending: false } : undefined
  );

  // Filter vessels to only show ones the user has logged time on
  const [vesselStateLogs, setVesselStateLogs] = useState<Map<string, StateLog[]>>(new Map());

  useEffect(() => {
    if (allVessels && user?.id) {
      const fetchLogs = async () => {
        const newLogs = new Map<string, StateLog[]>();
        await Promise.all(allVessels.map(async (vessel) => {
          const logs = await getVesselStateLogs(supabase, vessel.id, user.id);
          if (logs && logs.length > 0) {
            newLogs.set(vessel.id, logs);
          }
        }));
        setVesselStateLogs(newLogs);
      };
      fetchLogs();
    }
  }, [allVessels, user?.id, supabase]);

  const vessels = useMemo(() => {
    if (!allVessels) return [];
    return allVessels.filter(vessel => {
      const logs = vesselStateLogs.get(vessel.id) || [];
      return logs.length > 0;
    });
  }, [allVessels, vesselStateLogs]);

  // Get current active vessel
  const currentVessel = useMemo(() => {
    if (!userProfile?.activeVesselId || !vessels.length) return null;
    return vessels.find(v => v.id === userProfile.activeVesselId) || null;
  }, [userProfile?.activeVesselId, vessels]);

  // Auto-select current vessel when dialog opens and trigger captain check
  useEffect(() => {
    if (isDialogOpen && currentVessel && !useDifferentVessel) {
      // Always set current vessel when dialog opens (unless user selected different)
      const currentValue = form.getValues('vessel_id');
      if (currentValue !== currentVessel.id) {
        form.setValue('vessel_id', currentVessel.id, { shouldValidate: false });
        console.log('[TESTIMONIALS] Auto-selected current vessel:', currentVessel.name);
      }
    }
  }, [isDialogOpen, currentVessel, useDifferentVessel, form]);

  // Also check for captain when current vessel is auto-selected
  useEffect(() => {
    if (isDialogOpen && currentVessel && !useDifferentVessel && watchedVesselId === currentVessel.id && !activeCaptain && !isCheckingCaptain) {
      // Trigger captain check by ensuring watchedVesselId is set
      // This will trigger the main captain check useEffect
      console.log('[TESTIMONIALS] Current vessel selected, captain check should trigger automatically');
    }
  }, [isDialogOpen, currentVessel, watchedVesselId, activeCaptain, isCheckingCaptain, useDifferentVessel]);

  // Reset form and useDifferentVessel when dialog closes
  useEffect(() => {
    if (!isDialogOpen) {
      // Small delay to allow dialog close animation
      setTimeout(() => {
        form.reset();
        setActiveCaptain(null);
      setAvailableCaptains([]);
        setAvailableCaptains([]);
        setUseDifferentVessel(false);
      }, 150);
    }
  }, [isDialogOpen, form]);

  // Fetch vessel assignments and state logs for selected vessel
  const [vesselAssignments, setVesselAssignments] = useState<VesselAssignment[]>([]);
  
  // Ref to track previous assignments for polling comparison
  const previousAssignmentsRef = useRef<VesselAssignment[]>([]);
  
  // Check for active captain when vessel is selected
  useEffect(() => {
    if (!watchedVesselId) {
      setActiveCaptain(null);
      setAvailableCaptains([]);
      form.setValue('captain_email', '', { shouldValidate: false });
      return;
    }

    let isCancelled = false;
    
    const checkActiveCaptain = async () => {
      setIsCheckingCaptain(true);
      console.log('[TESTIMONIALS] Checking for active captain for vessel:', watchedVesselId);
      
      try {
        // Fetch all active signing authorities (captains) for this vessel
        // Include both primary and non-primary captains
        console.log('[TESTIMONIALS] Querying signing authorities for vessel:', watchedVesselId);
        
        const { data: signingAuthorities, error: signingAuthorityError } = await supabase
          .from('vessel_signing_authorities')
          .select('captain_user_id, is_primary, vessel_id, end_date')
          .eq('vessel_id', watchedVesselId)
          .is('end_date', null)
          .order('is_primary', { ascending: false }); // Primary first

        console.log('[TESTIMONIALS] Signing authorities query result:', { 
          signingAuthorities, 
          signingAuthorityError,
          vesselId: watchedVesselId,
          count: signingAuthorities?.length || 0
        });
        
        // Also check ALL signing authorities (including inactive) for debugging
        const { data: allSigningAuthorities } = await supabase
          .from('vessel_signing_authorities')
          .select('captain_user_id, is_primary, vessel_id, end_date')
          .eq('vessel_id', watchedVesselId);
        
        console.log('[TESTIMONIALS] ALL signing authorities (including inactive):', {
          allSigningAuthorities,
          count: allSigningAuthorities?.length || 0
        });

        if (isCancelled) return;

        if (signingAuthorityError) {
          console.error('[TESTIMONIALS] Error querying for signing authorities:', {
            error: signingAuthorityError,
            code: signingAuthorityError.code,
            message: signingAuthorityError.message,
          });
          setActiveCaptain(null);
          setAvailableCaptains([]);
          form.setValue('captain_email', '', { shouldValidate: false });
          return;
        }

        if (!signingAuthorities || signingAuthorities.length === 0) {
          console.log('[TESTIMONIALS] No active signing authorities found for vessel:', {
            vesselId: watchedVesselId
          });
          setActiveCaptain(null);
          setAvailableCaptains([]);
          form.setValue('captain_email', '', { shouldValidate: false });
          return;
        }

        // Get captain user IDs from signing authorities
        const captainIds = signingAuthorities.map(sa => sa.captain_user_id).filter(Boolean);
        
        console.log('[TESTIMONIALS] Found captain IDs from signing_authorities:', {
          captainIds,
          count: captainIds.length
        });

        if (captainIds.length === 0) {
          console.log('[TESTIMONIALS] No captains found');
          setActiveCaptain(null);
          setAvailableCaptains([]);
          form.setValue('captain_email', '', { shouldValidate: false });
          return;
        }

        // Fetch onboard status for captains from vessel_assignments
        const { data: captainAssignments, error: assignmentsError } = await supabase
          .from('vessel_assignments')
          .select('user_id, onboard')
          .eq('vessel_id', watchedVesselId)
          .in('user_id', captainIds)
          .is('end_date', null); // Only active assignments
        
        console.log('[TESTIMONIALS] Fetched captain assignments for onboard status:', {
          assignments: captainAssignments,
          error: assignmentsError,
          count: captainAssignments?.length || 0
        });

        // Create a map of captain_id -> onboard status
        const onboardMap = new Map<string, boolean>();
        if (captainAssignments) {
          captainAssignments.forEach(assignment => {
            onboardMap.set(assignment.user_id, assignment.onboard || false);
          });
        }

        // Fetch captain profiles (RLS should work now with the fixed function)
        const captainProfiles = await Promise.all(
          captainIds.map(async (captainId) => {
            const { data: profile, error: profileError } = await supabase
              .from('users')
              .select('id, email, first_name, last_name, username')
              .eq('id', captainId)
              .maybeSingle();
            
            if (profileError) {
              console.error('[TESTIMONIALS] Error fetching captain profile:', {
                captainId,
                error: profileError,
                code: profileError.code,
                message: profileError.message,
              });
              return null;
            }
            
            if (profile) {
              const isPrimary = signingAuthorities.some(sa => 
                sa.captain_user_id === captainId && sa.is_primary
              );
              const onboard = onboardMap.get(captainId) || false;
              const name = profile.first_name && profile.last_name
                ? `${profile.first_name} ${profile.last_name}`.trim()
                : profile.username || 'Captain';
              
              return {
                id: profile.id,
                isPrimary: isPrimary || false,
                onboard: onboard,
                name: name,
                email: profile.email || '',
              };
            }
            return null;
          })
        );

        const validCaptains = captainProfiles.filter((c): c is NonNullable<typeof c> => c !== null);
        
        console.log('[TESTIMONIALS] Fetched captain profiles with onboard status:', {
          captains: validCaptains.map(c => ({
            id: c.id,
            name: c.name,
            onboard: c.onboard,
            isPrimary: c.isPrimary
          })),
          count: validCaptains.length
        });

        setAvailableCaptains(validCaptains);

        // Automatically select the onboard captain first, then primary, then first
        const defaultCaptain = validCaptains.find(c => c.onboard) 
          || validCaptains.find(c => c.isPrimary) 
          || validCaptains[0];
        
        if (defaultCaptain) {
          setActiveCaptain({ id: defaultCaptain.id });
          console.log('[TESTIMONIALS] Auto-selected captain:', {
            captainId: defaultCaptain.id,
            name: defaultCaptain.name,
            isPrimary: defaultCaptain.isPrimary,
            onboard: defaultCaptain.onboard,
            totalCaptains: validCaptains.length,
            selectionReason: defaultCaptain.onboard ? 'onboard' : defaultCaptain.isPrimary ? 'primary' : 'first'
          });
        }

        // Don't set captain_email - we're using captain_user_id for inbox matching
        form.setValue('captain_email', '', { shouldValidate: false });
        console.log('[TESTIMONIALS] Using onboard captain_user_id for inbox matching, no email needed');
      } catch (error) {
        if (isCancelled) return;
        console.error('[TESTIMONIALS] Error checking for active captain:', error);
        setActiveCaptain(null);
      setAvailableCaptains([]);
        form.setValue('captain_email', '', { shouldValidate: false });
      } finally {
        if (!isCancelled) {
          setIsCheckingCaptain(false);
        }
      }
    };

    checkActiveCaptain();

    return () => {
      isCancelled = true;
    };
  }, [watchedVesselId, supabase, form]);
  
  useEffect(() => {
    if (watchedVesselId && user?.id) {
      const fetchData = async () => {
        console.log('[TESTIMONIALS] Fetching logs for vessel:', {
          vesselId: watchedVesselId,
          userId: user.id
        });
        
        try {
          const [logs, assignments] = await Promise.all([
            getVesselStateLogs(supabase, watchedVesselId, user.id),
            getVesselAssignments(supabase, user.id)
          ]);
          
          console.log('[TESTIMONIALS] Fetched logs:', {
            count: logs.length,
            firstFew: logs.slice(0, 5).map(l => ({ date: l.date, state: l.state }))
          });
          
          setSelectedVesselLogs(logs);
          
          // Filter assignments for this vessel
          const vesselAssignments = assignments.filter(a => a.vesselId === watchedVesselId);
          setVesselAssignments(vesselAssignments);
          previousAssignmentsRef.current = [...vesselAssignments];
        } catch (error) {
          console.error('[TESTIMONIALS] Error fetching logs:', error);
          setSelectedVesselLogs([]);
          setVesselAssignments([]);
          previousAssignmentsRef.current = [];
        }
      };
      fetchData();

      // Set up real-time subscription to detect changes to vessel assignments
      // This will detect changes made from the mobile app or other sources
      const channel = supabase
        .channel(`testimonials-vessel-assignments-${user.id}-${Date.now()}`)
        .on(
          'postgres_changes',
          {
            event: '*', // INSERT, UPDATE, DELETE
            schema: 'public',
            table: 'vessel_assignments',
            filter: `user_id=eq.${user.id}`,
          },
          async (payload) => {
            console.log('[TESTIMONIALS] Vessel assignment changed via real-time:', payload);
            // Refetch assignments when changes are detected
            try {
              const assignments = await getVesselAssignments(supabase, user.id);
              const vesselAssignments = assignments.filter(a => a.vesselId === watchedVesselId);
              setVesselAssignments(vesselAssignments);
              previousAssignmentsRef.current = [...vesselAssignments];
            } catch (error) {
              console.error('[TESTIMONIALS] Error refetching assignments after change:', error);
            }
          }
        )
        .subscribe((status) => {
          console.log('[TESTIMONIALS] Real-time subscription status:', status);
          if (status === 'SUBSCRIBED') {
            console.log('[TESTIMONIALS] Successfully subscribed to vessel_assignments changes');
          } else if (status === 'CHANNEL_ERROR') {
            console.error('[TESTIMONIALS] Real-time subscription error - falling back to polling');
          }
        });

      // Fallback: Poll for changes every 3 seconds if real-time doesn't work
      // This ensures we detect changes even if real-time subscriptions fail
      const pollInterval = setInterval(async () => {
        try {
          const assignments = await getVesselAssignments(supabase, user.id);
          const vesselAssignments = assignments.filter(a => a.vesselId === watchedVesselId);
          
          // Check if assignments have changed by comparing end_date values
          // Use a more robust comparison
          const previous = previousAssignmentsRef.current;
          const previousMap = new Map(previous.map(a => [a.id, a]));
          const currentMap = new Map(vesselAssignments.map(a => [a.id, a]));
          
          const hasChanges = 
            vesselAssignments.length !== previous.length ||
            vesselAssignments.some(a => {
              const prev = previousMap.get(a.id);
              return !prev || 
                a.vesselId !== prev.vesselId ||
                a.startDate !== prev.startDate || 
                a.endDate !== prev.endDate;
            }) ||
            previous.some(a => !currentMap.has(a.id));
          
          if (hasChanges) {
            console.log('[TESTIMONIALS] Polling detected changes in vessel assignments', {
              previous: previous.map(a => ({ id: a.id, vesselId: a.vesselId, startDate: a.startDate, endDate: a.endDate })),
              current: vesselAssignments.map(a => ({ id: a.id, vesselId: a.vesselId, startDate: a.startDate, endDate: a.endDate }))
            });
            setVesselAssignments(vesselAssignments);
            previousAssignmentsRef.current = [...vesselAssignments];
          }
        } catch (error) {
          console.error('[TESTIMONIALS] Error polling vessel assignments:', error);
        }
      }, 3000); // Poll every 3 seconds (more frequent)

      return () => {
        supabase.removeChannel(channel);
        clearInterval(pollInterval);
      };
    } else {
      setSelectedVesselLogs([]);
      setVesselAssignments([]);
    }
  }, [watchedVesselId, user?.id, supabase]);

  // Calculate date range options based on vessel assignments and state logs
  const dateRangeOptions = useMemo(() => {
    // Only require vessel and logs - assignments are optional
    if (!watchedVesselId || selectedVesselLogs.length === 0) {
      return [];
    }

    const today = startOfDay(new Date());
    const options: Array<{ label: string; startDate: Date; endDate: Date }> = [];

    // Option 1: Period between last two leave periods (or before last leave if only one)
    // Find all unique leave dates (group consecutive leave days)
    const allLeaveDates = selectedVesselLogs
      .filter(log => log.state === 'on-leave')
      .map(log => parse(log.date, 'yyyy-MM-dd', new Date()))
      .sort((a, b) => a.getTime() - b.getTime());

    // Group consecutive leave dates into periods
    const leavePeriods: Array<{ start: Date; end: Date }> = [];
    if (allLeaveDates.length > 0) {
      let currentPeriodStart = allLeaveDates[0];
      let currentPeriodEnd = allLeaveDates[0];
      
      for (let i = 1; i < allLeaveDates.length; i++) {
        const daysDiff = differenceInDays(allLeaveDates[i], currentPeriodEnd);
        if (daysDiff <= 1) {
          // Consecutive or same day - extend current period
          currentPeriodEnd = allLeaveDates[i];
        } else {
          // Gap found - save current period and start new one
          leavePeriods.push({ start: currentPeriodStart, end: currentPeriodEnd });
          currentPeriodStart = allLeaveDates[i];
          currentPeriodEnd = allLeaveDates[i];
        }
      }
      // Add the last period
      leavePeriods.push({ start: currentPeriodStart, end: currentPeriodEnd });
    }

    if (leavePeriods.length >= 2) {
      // We have at least 2 leave periods - find onboard period between the last two
      const lastLeavePeriod = leavePeriods[leavePeriods.length - 1];
      const previousLeavePeriod = leavePeriods[leavePeriods.length - 2];
      
      // Find logged dates between the two leave periods (onboard period)
      const onboardDatesBetweenLeaves = selectedVesselLogs
        .filter(log => {
          const logDate = parse(log.date, 'yyyy-MM-dd', new Date());
          return logDate > previousLeavePeriod.end && logDate < lastLeavePeriod.start && log.state !== 'on-leave';
        })
        .map(log => parse(log.date, 'yyyy-MM-dd', new Date()))
        .sort((a, b) => a.getTime() - b.getTime());

      if (onboardDatesBetweenLeaves.length > 0) {
        const periodStart = onboardDatesBetweenLeaves[0];
        const periodEnd = onboardDatesBetweenLeaves[onboardDatesBetweenLeaves.length - 1];
        
        options.push({
          label: 'Between Last Two Leaves',
          startDate: periodStart,
          endDate: periodEnd,
        });
      }
    } else if (leavePeriods.length === 1) {
      // Only one leave period - find period before it
      const lastLeavePeriod = leavePeriods[0];
      
      // Find logged dates before the last leave
      const onboardDatesBeforeLeave = selectedVesselLogs
        .filter(log => {
          const logDate = parse(log.date, 'yyyy-MM-dd', new Date());
          return logDate < lastLeavePeriod.start && log.state !== 'on-leave';
        })
        .map(log => parse(log.date, 'yyyy-MM-dd', new Date()))
        .sort((a, b) => a.getTime() - b.getTime());

      if (onboardDatesBeforeLeave.length > 0) {
        const periodStart = onboardDatesBeforeLeave[0];
        const periodEnd = onboardDatesBeforeLeave[onboardDatesBeforeLeave.length - 1];
        
        options.push({
          label: 'Before Last Leave',
          startDate: periodStart,
          endDate: periodEnd,
        });
      }
    }

    // Option 2: Fixed time period options (Last 2, 3, 4 months)
    const twoMonthsAgo = subMonths(today, 2);
    const threeMonthsAgo = subMonths(today, 3);
    const fourMonthsAgo = subMonths(today, 4);

    // Check if we have logs in each period
    const hasLogsLast2Months = selectedVesselLogs.some(log => {
      const logDate = parse(log.date, 'yyyy-MM-dd', new Date());
      return logDate >= twoMonthsAgo;
    });

    const hasLogsLast3Months = selectedVesselLogs.some(log => {
      const logDate = parse(log.date, 'yyyy-MM-dd', new Date());
      return logDate >= threeMonthsAgo;
    });

    const hasLogsLast4Months = selectedVesselLogs.some(log => {
      const logDate = parse(log.date, 'yyyy-MM-dd', new Date());
      return logDate >= fourMonthsAgo;
    });

    if (hasLogsLast2Months) {
      options.push({
        label: 'Last 2 Months',
        startDate: twoMonthsAgo,
        endDate: today,
      });
    }

    if (hasLogsLast3Months) {
      options.push({
        label: 'Last 3 Months',
        startDate: threeMonthsAgo,
        endDate: today,
      });
    }

    if (hasLogsLast4Months) {
      options.push({
        label: 'Last 4 Months',
        startDate: fourMonthsAgo,
        endDate: today,
      });
    }


    return options;
  }, [watchedVesselId, vesselAssignments, selectedVesselLogs]);

  // Function to apply a date range option
  const applyDateRangeOption = (option: { startDate: Date; endDate: Date }) => {
    form.setValue('start_date', startOfDay(option.startDate));
    form.setValue('end_date', startOfDay(option.endDate));
  };

  // Calculate and display day counts preview
  const dayCountsPreview = useMemo(() => {
    if (!watchedStartDate || !watchedEndDate || selectedVesselLogs.length === 0) {
      return null;
    }

    const startDateStr = format(watchedStartDate, 'yyyy-MM-dd');
    const endDateStr = format(watchedEndDate, 'yyyy-MM-dd');
    
    return calculateDayCounts(selectedVesselLogs, startDateStr, endDateStr);
  }, [watchedStartDate, watchedEndDate, selectedVesselLogs]);

  // Fetch testimonials with captain profiles
  useEffect(() => {
    if (!user?.id) return;

    setIsLoadingTestimonials(true);
    const fetchTestimonials = async () => {
      try {
        const { data, error } = await supabase
          .from('testimonials')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error fetching testimonials:', error);
          setTestimonials([]);
          setIsLoadingTestimonials(false);
          return;
        }

        // Fetch captain profiles for testimonials with captain_user_id
        const testimonialsWithCaptains = await Promise.all(
          (data || []).map(async (testimonial: any) => {
            // Always fetch captain profile if captain_user_id exists (even if captain_email is already set)
            if (testimonial.captain_user_id) {
              try {
                // Fetch captain profile
                const { data: captainProfile, error: profileError } = await supabase
                  .from('users')
                  .select('email, first_name, last_name, username')
                  .eq('id', testimonial.captain_user_id)
                  .maybeSingle();
                
                if (profileError) {
                  console.error('[TESTIMONIALS] Error fetching captain profile:', {
                    error: profileError,
                    code: profileError.code,
                    message: profileError.message,
                    details: profileError.details,
                    hint: profileError.hint,
                    captain_user_id: testimonial.captain_user_id,
                  });
                  // Return testimonial with existing data even if profile fetch fails
                  return testimonial;
                }
                
                if (captainProfile) {
                  const captainFullName = captainProfile.first_name && captainProfile.last_name
                    ? `${captainProfile.first_name} ${captainProfile.last_name}`.trim()
                    : captainProfile.username || null;
                  
                  console.log('[TESTIMONIALS] Fetched captain profile:', {
                    captain_user_id: testimonial.captain_user_id,
                    name: captainFullName,
                    email: captainProfile.email,
                  });
                  
                  return {
                    ...testimonial,
                    captain_email: captainProfile.email || testimonial.captain_email || null,
                    captain_name: captainFullName || testimonial.captain_name || null,
                  };
                } else {
                  console.warn('[TESTIMONIALS] Captain profile not found for captain_user_id:', testimonial.captain_user_id);
                  // Return testimonial with existing data
                  return testimonial;
                }
              } catch (error) {
                console.error('[TESTIMONIALS] Exception fetching captain profile:', error);
                // Return testimonial with existing data
                return testimonial;
              }
            }
            return testimonial;
          })
        );

        setTestimonials(testimonialsWithCaptains as Testimonial[]);
      } catch (error) {
        console.error('Error fetching testimonials:', error);
        setTestimonials([]);
      } finally {
        setIsLoadingTestimonials(false);
      }
    };

    fetchTestimonials();
  }, [user?.id, supabase]);

  // Fetch Nav Watch Applications
  const fetchNavWatchApplications = async () => {
    if (!user?.id) return;
    
    setIsLoadingNavWatchApplications(true);
    try {
      const { data, error } = await supabase
        .from('nav_watch_applications')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('[NAV WATCH] Error fetching applications:', error);
        setNavWatchApplications([]);
        return;
      }

      setNavWatchApplications((data || []) as NavWatchApplication[]);
    } catch (error) {
      console.error('[NAV WATCH] Exception fetching applications:', error);
      setNavWatchApplications([]);
    } finally {
      setIsLoadingNavWatchApplications(false);
    }
  };

  // Delete Nav Watch Application
  const handleDeleteApplication = async (application: NavWatchApplication) => {
    if (!user?.id) {
      toast({
        title: 'Error',
        description: 'You must be logged in to delete applications.',
        variant: 'destructive',
      });
      return;
    }

    setIsDeletingApplication(true);
    try {
      console.log('[NAV WATCH] Attempting to delete application:', application.id);
      
      const { error } = await supabase
        .from('nav_watch_applications')
        .delete()
        .eq('id', application.id)
        .eq('user_id', user.id); // Ensure user can only delete their own applications

      if (error) {
        console.error('[NAV WATCH] Error deleting application:', error);
        throw error;
      }

      console.log('[NAV WATCH] Application deleted successfully');
      
      toast({
        title: 'Success',
        description: 'Application deleted successfully.',
      });

      // Refresh the applications list
      await fetchNavWatchApplications();
      
      // Close the delete dialog
      setApplicationToDelete(null);
    } catch (error: any) {
      console.error('[NAV WATCH] Exception deleting application:', error);
      toast({
        title: 'Error',
        description: error.message || 'Failed to delete application. Please try again.',
        variant: 'destructive',
      });
    } finally {
      setIsDeletingApplication(false);
    }
  };

  // Fetch applications when document type changes to nav_watch_application
  useEffect(() => {
    if (documentType === 'nav_watch_application' && user?.id) {
      fetchNavWatchApplications();
    }
  }, [documentType, user?.id]);

  const handleNavWatchSubmit = async (data: NavWatchApplicationFormValues) => {
    if (!user?.id || !userProfile) return;

    setIsSaving(true);
    try {
      // Fetch sea service records for ALL vessels the user has served on
      // Use approved testimonials as the primary source (official records)
      const seaServiceRecords: Array<{
        vesselName: string;
        flag: string;
        imoNumber?: string;
        grossTonnage?: number;
        kilowatts?: number;
        length?: number;
        capacity?: string;
        fromDate: string;
        toDate: string;
        totalDays: number;
        daysAtSea: number;
      }> = [];

      // First, try to get approved testimonials (official sea service records)
      const { data: approvedTestimonials, error: testimonialsError } = await supabase
        .from('testimonials')
        .select('*, vessels(*)')
        .eq('user_id', user.id)
        .eq('status', 'approved')
        .order('start_date', { ascending: true });

      if (testimonialsError) {
        console.error('[NAV WATCH] Error fetching testimonials:', testimonialsError);
      }

      // Process approved testimonials first (these are official records)
      // Group by vessel to combine date ranges
      if (approvedTestimonials && approvedTestimonials.length > 0) {
        // Group testimonials by vessel_id
        const vesselTestimonialsMap = new Map<string, Array<typeof approvedTestimonials[0]>>();
        
        for (const testimonial of approvedTestimonials) {
          const vesselId = testimonial.vessel_id;
          if (!vesselTestimonialsMap.has(vesselId)) {
            vesselTestimonialsMap.set(vesselId, []);
          }
          vesselTestimonialsMap.get(vesselId)!.push(testimonial);
        }

        // Process each vessel once, combining all testimonials for that vessel
        for (const [vesselId, testimonials] of vesselTestimonialsMap.entries()) {
          const vessel = testimonials[0].vessels as any;
          if (!vessel) continue;

          // Find the earliest start date and latest end date across all testimonials for this vessel
          let earliestStart = new Date(testimonials[0].start_date);
          let latestEnd: Date | null = testimonials[0].end_date ? new Date(testimonials[0].end_date) : null;

          for (const testimonial of testimonials) {
          const startDate = new Date(testimonial.start_date);
            const endDate = testimonial.end_date ? new Date(testimonial.end_date) : null;

            if (startDate < earliestStart) {
              earliestStart = startDate;
            }

            if (endDate) {
              if (!latestEnd || endDate > latestEnd) {
                latestEnd = endDate;
              }
            } else {
              // If any testimonial has no end date, use current date
              latestEnd = new Date();
            }
          }

          // Use current date if no end date found
          const endDate = latestEnd || new Date();

          // Get state logs for this vessel and combined period to calculate days at sea
          const logs = await getVesselStateLogs(supabase, vesselId, user.id);
          const periodLogs = logs.filter(log => {
            const logDate = new Date(log.date);
            return logDate >= earliestStart && logDate <= endDate;
          });

          // Calculate days at sea (underway state)
          const daysAtSea = periodLogs.filter(log => log.state === 'underway').length;
          const totalDays = Math.ceil((endDate.getTime() - earliestStart.getTime()) / (1000 * 60 * 60 * 24));

          seaServiceRecords.push({
            vesselName: vessel.name || 'Unknown Vessel',
            flag: vessel.flag_state || '',
            imoNumber: vessel.official_number || vessel.imo || undefined,
            grossTonnage: vessel.gross_tonnage || undefined,
            kilowatts: undefined, // Not stored in vessel data
            length: vessel.length_m || undefined,
            capacity: userProfile.position || undefined,
            fromDate: format(earliestStart, 'dd/MM/yyyy'),
            toDate: format(endDate, 'dd/MM/yyyy'),
            totalDays,
            daysAtSea,
          });
        }
      }

      // If no testimonials, fall back to vessel assignments
      if (seaServiceRecords.length === 0) {
      const assignments = await getVesselAssignments(supabase, user.id);
      
      // Group assignments by vessel and calculate service periods
      const vesselServiceMap = new Map<string, Array<{ start: Date; end: Date | null; position?: string }>>();
      
      assignments.forEach((assignment) => {
        if (!vesselServiceMap.has(assignment.vesselId)) {
          vesselServiceMap.set(assignment.vesselId, []);
        }
        const periods = vesselServiceMap.get(assignment.vesselId)!;
        periods.push({
          start: new Date(assignment.startDate),
          end: assignment.endDate ? new Date(assignment.endDate) : null,
          position: assignment.position || undefined,
        });
      });

      // Process each vessel to create sea service records
      const vesselsToProcess = allVessels || [];
      for (const vessel of vesselsToProcess) {
        const periods = vesselServiceMap.get(vessel.id);
        if (!periods || periods.length === 0) continue;

        // Find the earliest start date and latest end date across all periods for this vessel
        let earliestStart = periods[0].start;
        let latestEnd: Date | null = periods[0].end;

        for (const period of periods) {
          if (period.start < earliestStart) {
            earliestStart = period.start;
          }

          if (period.end) {
            if (!latestEnd || period.end > latestEnd) {
              latestEnd = period.end;
            }
          } else {
            // If any period has no end date, use current date
            latestEnd = new Date();
          }
        }

        // Use current date if no end date found
        const endDate = latestEnd || new Date();

        // Get state logs for this vessel and combined period to calculate days at sea
        const logs = await getVesselStateLogs(supabase, vessel.id, user.id);
          const periodLogs = logs.filter(log => {
            const logDate = new Date(log.date);
          return logDate >= earliestStart && logDate <= endDate;
          });

          // Calculate days at sea (underway state)
          const daysAtSea = periodLogs.filter(log => log.state === 'underway').length;
        const totalDays = Math.ceil((endDate.getTime() - earliestStart.getTime()) / (1000 * 60 * 60 * 24));

        // Use the most recent position if available
        const mostRecentPeriod = periods.reduce((latest, current) => {
          return (!latest.end || (current.end && current.end > latest.end)) ? current : latest;
        });

          seaServiceRecords.push({
            vesselName: vessel.name,
            flag: vessel.flag_state || '',
            imoNumber: vessel.officialNumber || undefined,
            grossTonnage: vessel.gross_tonnage || undefined,
            kilowatts: undefined, // Not stored in vessel data
            length: vessel.length_m || undefined,
          capacity: mostRecentPeriod.position || userProfile.position || undefined,
          fromDate: format(earliestStart, 'dd/MM/yyyy'),
          toDate: format(endDate, 'dd/MM/yyyy'),
            totalDays,
            daysAtSea,
        });
        }
      }

      console.log('[NAV WATCH] Sea service records:', seaServiceRecords);

      // Format date of birth for MCA form (DD/MM/YYYY)
      const dateOfBirth = (userProfile as any).dateOfBirth 
        ? format(parse((userProfile as any).dateOfBirth, 'yyyy-MM-dd', new Date()), 'dd/MM/yyyy')
        : '';

      // Extract name parts - prioritize lastName/firstName, fallback to username parsing
      const surname = userProfile.lastName || (userProfile.username.includes(' ') 
        ? userProfile.username.split(' ').slice(-1)[0] 
        : userProfile.username.split(' ')[0] || '');
      const forenames = userProfile.firstName || (userProfile.username.includes(' ')
        ? userProfile.username.split(' ').slice(0, -1).join(' ') || userProfile.username
        : '');

      console.log('[NAV WATCH] User data being used:', {
        surname,
        forenames,
        dateOfBirth,
        email: userProfile.email,
        username: userProfile.username,
        firstName: userProfile.firstName,
        lastName: userProfile.lastName,
      });

      // Get MCA application details from user profile - check both snake_case and camelCase
      const getProfileField = (snakeCase: string, camelCase: string): string | undefined => {
        const value = (userProfile as any)[snakeCase] || (userProfile as any)[camelCase];
        return value && value.trim() ? value.trim() : undefined;
      };

      const mcaDetails = {
        title: getProfileField('title', 'title'),
        placeOfBirth: getProfileField('place_of_birth', 'placeOfBirth'),
        countryOfBirth: getProfileField('country_of_birth', 'countryOfBirth'),
        nationality: getProfileField('nationality', 'nationality'),
        telephone: getProfileField('telephone', 'telephone'),
        mobile: getProfileField('mobile', 'mobile'),
        addressLine1: getProfileField('address_line1', 'addressLine1') || '',
        addressLine2: getProfileField('address_line2', 'addressLine2'),
        addressDistrict: getProfileField('address_district', 'addressDistrict'),
        addressTownCity: getProfileField('address_town_city', 'addressTownCity') || '',
        addressCountyState: getProfileField('address_county_state', 'addressCountyState'),
        addressPostCode: getProfileField('address_post_code', 'addressPostCode') || '',
        addressCountry: getProfileField('address_country', 'addressCountry') || '',
      };

      console.log('[NAV WATCH] MCA Details extracted:', mcaDetails);

      // Map certificate type to display label
      const certificateTypeLabels: Record<string, string> = {
        'navigational_ii4': 'Navigational Watch Rating Certificate II/4',
        'navigational_iii4': 'Navigational Watch Rating Certificate III/4',
        'electro_technical': 'Electro-technical Rating III/7',
      };

      const personalDetailsData = {
        title: mcaDetails.title,
        surname: surname,
        forenames: forenames || surname, // Fallback to surname if no forenames
        dateOfBirth: dateOfBirth,
        placeOfBirth: mcaDetails.placeOfBirth,
        countryOfBirth: mcaDetails.countryOfBirth,
        nationality: mcaDetails.nationality,
        address: {
          line1: mcaDetails.addressLine1,
          line2: mcaDetails.addressLine2,
          district: mcaDetails.addressDistrict,
          townCity: mcaDetails.addressTownCity,
          countyState: mcaDetails.addressCountyState,
          postCode: mcaDetails.addressPostCode,
          country: mcaDetails.addressCountry,
        },
        telephone: mcaDetails.telephone,
        mobile: mcaDetails.mobile,
        email: userProfile.email || '',
        // Store the specific certificate type selected by user
        certificateTypeSelected: certificateTypeLabels[data.certificate_type] || data.certificate_type,
        // Section 4: Checklist (only for Navigational and Engine Room)
        checklistNavEngine: (data.certificate_type !== 'electro_technical' && data.checklist) ? data.checklist : null,
        // Section 5: ETR Checklist (only for Electro-technical)
        checklistETR: (data.certificate_type === 'electro_technical' && data.checklistETR) ? data.checklistETR : null,
        // Section 7: Countersign (available for all certificate types when checkbox is checked)
        counterSign: (data.includeCountersign && data.counterSign) ? {
          ...data.counterSign,
          signatureDataUrl: undefined, // Countersign signature not implemented yet
        } : null,
        // Section 6: Declaration signature
        signatureDataUrl: data.signatureDataUrl || null,
      };

      console.log('[NAV WATCH] Personal details data for PDF:', personalDetailsData);

      // Map form certificate type to PDF generator certificate type
      // navigational_ii4 -> 'navigational', navigational_iii4 -> 'engine_room', electro_technical -> 'electro_technical'
      const certificateTypeValue = data.certificate_type === 'electro_technical' 
        ? 'electro_technical' 
        : data.certificate_type === 'navigational_iii4'
        ? 'engine_room'
        : 'navigational';

      // Generate MCA Watch Rating Form PDF
      await generateMCAWatchRatingForm({
        personalDetails: personalDetailsData,
        certificateType: certificateTypeValue,
        seaServiceRecords: seaServiceRecords,
        userProfile: {
          firstName: userProfile.firstName,
          lastName: userProfile.lastName,
          username: userProfile.username,
          email: userProfile.email || '',
          dateOfBirth: (userProfile as any).dateOfBirth || null,
          position: userProfile.position || null,
          dischargeBookNumber: userProfile.dischargeBookNumber || null,
        },
      }, 'download', { debug: true });

      // Save application to database
      try {
        const { data: savedApplication, error: saveError } = await supabase
          .from('nav_watch_applications')
          .insert({
            user_id: user.id,
            certificate_type: certificateTypeValue, // Already mapped to 'navigational' or 'electro_technical'
            personal_details: personalDetailsData,
            sea_service_records: seaServiceRecords,
          })
          .select()
          .single();

        if (saveError) {
          console.error('[NAV WATCH] Error saving application:', saveError);
          // Don't fail the whole operation if save fails
        } else {
          console.log('[NAV WATCH] Application saved successfully:', savedApplication.id);
        }
      } catch (error) {
        console.error('[NAV WATCH] Exception saving application:', error);
        // Don't fail the whole operation if save fails
      }

      toast({
        title: 'Success',
        description: 'MCA Watch Rating Application PDF generated successfully.',
      });

      setIsNavWatchDialogOpen(false);
      navWatchForm.reset();
      
      // Refresh applications list
      if (documentType === 'nav_watch_application') {
        fetchNavWatchApplications();
      }
    } catch (error: any) {
      console.error('Error generating MCA Watch Rating Application PDF:', error);
      toast({
        title: 'Error',
        description: error.message || 'Failed to generate PDF. Please try again.',
        variant: 'destructive',
      });
    } finally {
      setIsSaving(false);
    }
  };

  const handleOowSubmit = async (data: OOWApplicationFormValues) => {
    if (!user?.id || !userProfile) return;

    setIsSaving(true);
    try {
      // Fetch sea service records (same logic as Nav Watch)
      const seaServiceRecords: Array<{
        vesselName: string;
        imoNumber?: string;
        type?: string;
        grossTonnage?: number;
        voyage?: string;
        rankCapacity: string;
        fromDate: string;
        toDate: string;
        months: number;
        days: number;
      }> = [];

      // Get approved testimonials
      const { data: approvedTestimonials } = await supabase
        .from('testimonials')
        .select('*, vessels(*)')
        .eq('user_id', user.id)
        .eq('status', 'approved')
        .order('start_date', { ascending: true });

      if (approvedTestimonials && approvedTestimonials.length > 0) {
        const vesselTestimonialsMap = new Map<string, Array<typeof approvedTestimonials[0]>>();
        
        for (const testimonial of approvedTestimonials) {
          const vesselId = testimonial.vessel_id;
          if (!vesselTestimonialsMap.has(vesselId)) {
            vesselTestimonialsMap.set(vesselId, []);
          }
          vesselTestimonialsMap.get(vesselId)!.push(testimonial);
        }

        for (const [vesselId, testimonials] of vesselTestimonialsMap.entries()) {
          const vessel = testimonials[0].vessels as any;
          if (!vessel) continue;

          let earliestStart = new Date(testimonials[0].start_date);
          let latestEnd: Date | null = testimonials[0].end_date ? new Date(testimonials[0].end_date) : null;

          for (const testimonial of testimonials) {
            const startDate = new Date(testimonial.start_date);
            const endDate = testimonial.end_date ? new Date(testimonial.end_date) : null;

            if (startDate < earliestStart) {
              earliestStart = startDate;
            }

            if (endDate) {
              if (!latestEnd || endDate > latestEnd) {
                latestEnd = endDate;
              }
            } else {
              latestEnd = new Date();
            }
          }

          const endDate = latestEnd || new Date();
          const totalDays = Math.ceil((endDate.getTime() - earliestStart.getTime()) / (1000 * 60 * 60 * 24));
          const months = Math.floor(totalDays / 30);
          const days = totalDays % 30;

          seaServiceRecords.push({
            vesselName: vessel.name || 'Unknown Vessel',
            imoNumber: vessel.official_number || vessel.imo || undefined,
            grossTonnage: vessel.gross_tonnage || undefined,
            voyage: 'U', // Default to Unlimited - can be enhanced later
            rankCapacity: userProfile.position || '',
            fromDate: format(earliestStart, 'dd/MM/yyyy'),
            toDate: format(endDate, 'dd/MM/yyyy'),
            months,
            days,
          });
        }
      }

      // Format date of birth
      const dateOfBirth = (userProfile as any).dateOfBirth 
        ? format(parse((userProfile as any).dateOfBirth, 'yyyy-MM-dd', new Date()), 'dd/MM/yyyy')
        : '';

      const surname = userProfile.lastName || (userProfile.username.includes(' ') 
        ? userProfile.username.split(' ').slice(-1)[0] 
        : userProfile.username.split(' ')[0] || '');
      const forenames = userProfile.firstName || (userProfile.username.includes(' ')
        ? userProfile.username.split(' ').slice(0, -1).join(' ') || userProfile.username
        : '');

      // Get MCA details
      const getProfileField = (snakeCase: string, camelCase: string): string | undefined => {
        const value = (userProfile as any)[snakeCase] || (userProfile as any)[camelCase];
        return value && value.trim() ? value.trim() : undefined;
      };

      const mcaDetails = {
        title: getProfileField('title', 'title'),
        placeOfBirth: getProfileField('place_of_birth', 'placeOfBirth'),
        countryOfBirth: getProfileField('country_of_birth', 'countryOfBirth'),
        nationality: getProfileField('nationality', 'nationality'),
        telephone: getProfileField('telephone', 'telephone'),
        addressLine1: getProfileField('address_line1', 'addressLine1') || '',
        addressLine2: getProfileField('address_line2', 'addressLine2'),
        addressTownCity: getProfileField('address_town_city', 'addressTownCity') || '',
        addressCountyState: getProfileField('address_county_state', 'addressCountyState'),
        addressPostCode: getProfileField('address_post_code', 'addressPostCode') || '',
        addressCountry: getProfileField('address_country', 'addressCountry') || '',
      };

      // Generate OOW PDF
      await generateMCAOOWForm_MSF_4274({
        certificateType: data.certificate_type,
        personalDetails: {
          title: mcaDetails.title,
          surname,
          forenames: forenames || surname,
          dateOfBirth,
          placeOfBirth: mcaDetails.placeOfBirth,
          countryOfBirth: mcaDetails.countryOfBirth,
          nationality: mcaDetails.nationality,
        },
        homeAddress: {
          line1: mcaDetails.addressLine1,
          line2: mcaDetails.addressLine2,
          townCity: mcaDetails.addressTownCity,
          countyState: mcaDetails.addressCountyState,
          postCode: mcaDetails.addressPostCode,
          country: mcaDetails.addressCountry,
          email: userProfile.email || '',
          telephone: mcaDetails.telephone,
        },
        seaServiceRecords,
        declaration: {
          signatureDataUrl: data.signatureDataUrl || null,
          date: format(new Date(), 'dd/MM/yyyy'),
          printName: `${forenames} ${surname}`.trim(),
        },
      }, 'download');

      toast({
        title: 'Success',
        description: 'OOW application PDF generated successfully.',
      });

      setIsOowDialogOpen(false);
      oowForm.reset();
    } catch (error: any) {
      console.error('Error generating OOW Application PDF:', error);
      toast({
        title: 'Error',
        description: error.message || 'Failed to generate PDF. Please try again.',
        variant: 'destructive',
      });
    } finally {
      setIsSaving(false);
    }
  };

  const handleSubmit = async (data: TestimonialFormValues) => {
    if (!user?.id) return;

    setIsSaving(true);
    try {
      const startDateStr = format(data.start_date, 'yyyy-MM-dd');
      const endDateStr = format(data.end_date, 'yyyy-MM-dd');

      // Always fetch fresh logs to ensure we have the latest data
      // This ensures logs are available even if dates were manually selected before logs finished loading
      console.log('[TESTIMONIALS] Fetching logs for submission:', {
        vesselId: data.vessel_id,
        userId: user.id,
        selectedVesselLogsCount: selectedVesselLogs.length
      });
      
      let logsToUse: StateLog[];
      try {
        logsToUse = await getVesselStateLogs(supabase, data.vessel_id, user.id);
        console.log('[TESTIMONIALS] Fetched logs for submission:', {
          count: logsToUse.length,
          firstFew: logsToUse.slice(0, 5).map(l => ({ date: l.date, state: l.state }))
        });
        
        // Update selectedVesselLogs state for UI consistency
        if (logsToUse.length > 0) {
          setSelectedVesselLogs(logsToUse);
        }
      } catch (error: any) {
        console.error('[TESTIMONIALS] Error fetching logs for submission:', {
          error,
          message: error?.message,
          code: error?.code,
          details: error?.details
        });
        toast({
          title: 'Error',
          description: error?.message || 'Failed to fetch vessel logs. Please ensure you have logged time on this vessel.',
          variant: 'destructive',
        });
        setIsSaving(false);
        return;
      }
      
      if (!logsToUse || logsToUse.length === 0) {
        toast({
          title: 'No Logs Found',
          description: 'No logged dates found for this vessel. Please ensure you have logged time on this vessel before requesting a testimonial.',
          variant: 'destructive',
        });
        setIsSaving(false);
        return;
      }

      console.log('[TESTIMONIALS] Calculating day counts with logs:', {
        logCount: logsToUse.length,
        dateRange: { start: startDateStr, end: endDateStr },
        logsInRange: logsToUse.filter(log => {
          const logDate = parse(log.date, 'yyyy-MM-dd', new Date());
          const start = parse(startDateStr, 'yyyy-MM-dd', new Date());
          const end = parse(endDateStr, 'yyyy-MM-dd', new Date());
          return logDate >= start && logDate <= end;
        }).length
      });

      // Calculate day counts
      const dayCounts = calculateDayCounts(logsToUse, startDateStr, endDateStr);
      
      console.log('[TESTIMONIALS] Calculated day counts:', dayCounts);

      // Validate that total_days equals the sum (required by database constraint)
      const calculatedTotal = dayCounts.at_sea_days + dayCounts.standby_days + dayCounts.yard_days + dayCounts.leave_days;
      if (dayCounts.total_days !== calculatedTotal) {
        console.warn('Day counts mismatch, adjusting total_days:', {
          original: dayCounts.total_days,
          calculated: calculatedTotal,
          dayCounts,
        });
        dayCounts.total_days = calculatedTotal;
      }

      // Determine initial status: if captain_email is provided, status is 'pending_captain', otherwise 'draft'
      const initialStatus: TestimonialStatus = data.captain_email ? 'pending_captain' : 'draft';

      // Determine captain_user_id and captain_email
      // If activeCaptain is found (SeaJourney user), use their user_id
      // Otherwise, use the email provided by the user for external captains
      const captainUserId = activeCaptain?.id || null;
      const captainEmail = captainUserId ? null : (data.captain_email || null); // Only use email for external captains
      const captainName = data.captain_name || null; // Optional name field

      console.log('[TESTIMONIALS] Creating testimonial with captain info:', {
        activeCaptain: activeCaptain,
        captainUserId,
        captainEmail,
        captainName,
        vesselId: data.vessel_id
      });

      // If we have an active captain (SeaJourney user), set status to pending_captain
      // They will see it in their inbox automatically
      const finalStatus: TestimonialStatus = captainUserId ? 'pending_captain' : initialStatus;

      console.log('[TESTIMONIALS] Final testimonial status:', finalStatus);

      // Create testimonial (testimonial_code will be auto-generated by database trigger when approved)
      const testimonialData = {
          user_id: user.id,
          vessel_id: data.vessel_id,
          start_date: startDateStr,
          end_date: endDateStr,
          total_days: dayCounts.total_days,
          at_sea_days: dayCounts.at_sea_days,
          standby_days: dayCounts.standby_days,
          yard_days: dayCounts.yard_days,
          leave_days: dayCounts.leave_days,
          status: finalStatus,
          captain_user_id: captainUserId,
          captain_email: captainEmail,
          captain_name: captainName,
          official_body: data.official_body || null,
          official_reference: data.official_reference || null,
          notes: data.notes || null,
          // testimonial_code is NOT set here - it will be auto-generated by database trigger when status changes to 'approved'
      };

      console.log('[TESTIMONIALS] Inserting testimonial with data:', {
        ...testimonialData,
        // Don't log notes if it's long
        notes: testimonialData.notes ? (testimonialData.notes.length > 50 ? testimonialData.notes.substring(0, 50) + '...' : testimonialData.notes) : null
      });

      const result = await supabase
        .from('testimonials')
        .insert(testimonialData)
        .select()
        .single();

      if (result.error) {
        console.error('[TESTIMONIALS] Error creating testimonial:', result.error);
        throw result.error;
      }

      const createdTestimonial = result.data;
      
      console.log('[TESTIMONIALS]  Testimonial created successfully:', {
        id: createdTestimonial.id,
        captain_user_id: createdTestimonial.captain_user_id,
        status: createdTestimonial.status,
        vessel_id: createdTestimonial.vessel_id,
        user_id: createdTestimonial.user_id
      });

      // Send email to captain if captain_email is provided AND there's no active captain (SeaJourney user)
      // If there's an active captain (captain_user_id), the testimonial will appear in their inbox automatically
      if (captainEmail && finalStatus === 'pending_captain' && !captainUserId) {
        // External captain (not a SeaJourney user) - send email
        const vesselName = vessels.find(v => v.id === data.vessel_id)?.name || 'Unknown Vessel';
        
        await requestCaptainSignoff(
          supabase,
          {
            ...createdTestimonial,
            vessel_name: vesselName,
          } as Testimonial & { vessel_name: string },
          toast
        );
      } else if (captainUserId) {
        // Active SeaJourney captain found - testimonial goes to inbox automatically, no email needed
        toast({
          title: 'Testimonial Request Sent',
          description: 'Your testimonial request has been sent to the captain\'s inbox. They will be notified.',
        });
      } else {
        toast({
          title: 'Testimonial Created',
          description: 'Testimonial has been saved as draft. You can edit it later or send it to a captain.',
        });
      }


      form.reset();
      setActiveCaptain(null);
      setAvailableCaptains([]); // Clear active captain when dialog closes
      setIsDialogOpen(false);
      
      // Refresh testimonials list with captain profiles
      const { data: updatedData, error: refreshError } = await supabase
        .from('testimonials')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });
      
      if (refreshError) {
        console.error('[TESTIMONIALS] Error refreshing testimonials:', refreshError);
      } else if (updatedData) {
        // Fetch captain profiles for testimonials with captain_user_id (same logic as main fetch)
        const testimonialsWithCaptains = await Promise.all(
          updatedData.map(async (testimonial: any) => {
            if (testimonial.captain_user_id) {
              try {
                const { data: captainProfile, error: profileError } = await supabase
                  .from('users')
                  .select('email, first_name, last_name, username')
                  .eq('id', testimonial.captain_user_id)
                  .maybeSingle();
                
                if (profileError) {
                  console.error('[TESTIMONIALS] Error fetching captain profile after creation:', {
                    error: profileError,
                    code: profileError.code,
                    message: profileError.message,
                    captain_user_id: testimonial.captain_user_id,
                  });
                  return testimonial;
                }
                
                if (captainProfile) {
                  const captainFullName = captainProfile.first_name && captainProfile.last_name
                    ? `${captainProfile.first_name} ${captainProfile.last_name}`.trim()
                    : captainProfile.username || null;
                  
                  console.log('[TESTIMONIALS] Fetched captain profile after creation:', {
                    captain_user_id: testimonial.captain_user_id,
                    name: captainFullName,
                    email: captainProfile.email,
                  });
                  
                  return {
                    ...testimonial,
                    captain_email: captainProfile.email || testimonial.captain_email || null,
                    captain_name: captainFullName || testimonial.captain_name || null,
                  };
                }
              } catch (error) {
                console.error('[TESTIMONIALS] Exception fetching captain profile after creation:', error);
              }
            }
            return testimonial;
          })
        );
        
        setTestimonials(testimonialsWithCaptains as Testimonial[]);
      }
    } catch (error: any) {
      console.error('Error creating testimonial:', error);
      toast({
        title: 'Error',
        description: error.message || 'Failed to create testimonial. Please try again.',
        variant: 'destructive',
      });
    } finally {
      setIsSaving(false);
    }
  };

  const filteredTestimonials = useMemo(() => {
    if (activeTab === 'all') return testimonials;
    if (activeTab === 'pending') {
      // Show both pending_captain and pending_official when 'pending' is selected
      return testimonials.filter(t => t.status === 'pending_captain' || t.status === 'pending_official');
    }
    return testimonials.filter(t => t.status === activeTab);
  }, [testimonials, activeTab]);

  const getVesselName = (vesselId: string) => {
    return vessels.find(v => v.id === vesselId)?.name || 'Unknown Vessel';
  };

  const getVesselDetails = (vesselId: string) => {
    return vessels.find(v => v.id === vesselId);
  };

  const handleGeneratePDF = async (testimonial: Testimonial, format: TestimonialPDFFormat = 'seajourney') => {
    if (!userProfile) {
      toast({
        title: 'Error',
        description: 'User profile not loaded.',
        variant: 'destructive',
      });
      return;
    }

    const vessel = getVesselDetails(testimonial.vessel_id);
    if (!vessel) {
      toast({
        title: 'Error',
        description: 'Vessel details not found.',
        variant: 'destructive',
      });
      return;
    }

    // For approved testimonials, fetch from approved_testimonials table (immutable snapshot with captain signature and comments)
    let captainSignature = testimonial.captain_signature || null;
    let captainCommentConduct = (testimonial as any).captain_comment_conduct || null;
    let captainCommentAbility = (testimonial as any).captain_comment_ability || null;
    let captainCommentGeneral = (testimonial as any).captain_comment_general || null;
    let approvedAt = null;
    
    if (testimonial.status === 'approved') {
      try {
        console.log('[PDF GENERATION] Fetching approved testimonial snapshot for:', testimonial.id);
        const { data: approvedSnapshot, error: snapshotError } = await supabase
          .from('approved_testimonials')
          .select('captain_signature, captain_comment_conduct, captain_comment_ability, captain_comment_general, approved_at')
          .eq('testimonial_id', testimonial.id)
          .maybeSingle();

        if (snapshotError) {
          console.error('[PDF GENERATION] Error fetching approved snapshot:', snapshotError);
        } else if (approvedSnapshot) {
          if (approvedSnapshot.captain_signature) {
            captainSignature = approvedSnapshot.captain_signature;
            console.log('[PDF GENERATION] Using captain signature from approved snapshot:', {
              hasSignature: true,
              signatureLength: captainSignature?.length || 0
            });
          }
          if (approvedSnapshot.captain_comment_conduct) {
            captainCommentConduct = approvedSnapshot.captain_comment_conduct;
          }
          if (approvedSnapshot.captain_comment_ability) {
            captainCommentAbility = approvedSnapshot.captain_comment_ability;
          }
          if (approvedSnapshot.captain_comment_general) {
            captainCommentGeneral = approvedSnapshot.captain_comment_general;
          }
          if (approvedSnapshot.approved_at) {
            approvedAt = approvedSnapshot.approved_at;
            console.log('[PDF GENERATION] Using approved_at date from approved snapshot:', approvedAt);
          }
        } else {
          console.log('[PDF GENERATION] No snapshot found in approved_testimonials');
        }
      } catch (error) {
        console.error('[PDF GENERATION] Exception fetching approved snapshot:', error);
      }
    }

    // Fetch captain profile if captain_user_id is available (fallback for legacy data)
    let captainProfile = null;
    if (testimonial.captain_user_id) {
      try {
        console.log('[PDF GENERATION] Fetching captain profile for user_id:', testimonial.captain_user_id);
        const { data: captainData, error: captainError } = await supabase
          .from('users')
          .select('first_name, last_name, position, email, signature')
          .eq('id', testimonial.captain_user_id)
          .maybeSingle();

        if (captainError) {
          console.error('[PDF GENERATION] Error fetching captain profile:', {
            error: captainError,
            code: captainError?.code,
            message: captainError?.message,
            details: captainError?.details,
            hint: captainError?.hint,
            captain_user_id: testimonial.captain_user_id,
          });
        } else if (captainData) {
          console.log('[PDF GENERATION] Captain profile fetched:', {
            ...captainData,
            signature: captainData.signature ? `${captainData.signature.substring(0, 50)}... (length: ${captainData.signature.length})` : null
          });
          captainProfile = {
            firstName: captainData.first_name || undefined,
            lastName: captainData.last_name || undefined,
            position: captainData.position || null,
            email: captainData.email || undefined,
            signature: captainData.signature || null,
          };
          console.log('[PDF GENERATION] Captain profile with signature set:', {
            hasSignature: !!captainProfile.signature,
            signatureLength: captainProfile.signature?.length || 0
          });
        } else {
          console.log('[PDF GENERATION] No captain profile found for user_id:', testimonial.captain_user_id);
        }
      } catch (error) {
        console.error('[PDF GENERATION] Exception fetching captain profile:', error);
        // Continue without captain profile - will use testimonial.captain_name/email
      }
    } else {
      console.log('[PDF GENERATION] No captain_user_id, using testimonial.captain_name/email:', {
        captain_name: testimonial.captain_name,
        captain_email: testimonial.captain_email
      });
    }

    try {
      await generateTestimonialPDF({
      testimonial: {
        id: testimonial.id,
        start_date: testimonial.start_date,
        end_date: testimonial.end_date,
        total_days: testimonial.total_days,
        at_sea_days: testimonial.at_sea_days,
        standby_days: testimonial.standby_days,
        yard_days: testimonial.yard_days,
        leave_days: testimonial.leave_days,
        captain_name: testimonial.captain_name,
        captain_email: testimonial.captain_email,
        captain_position: (testimonial as any).captain_position || null,
        captain_signature: captainSignature, // Use signature from approved snapshot or testimonial
        captain_comment_conduct: captainCommentConduct, // Use comments from approved snapshot or testimonial
        captain_comment_ability: captainCommentAbility,
        captain_comment_general: captainCommentGeneral,
        official_body: testimonial.official_body,
        official_reference: testimonial.official_reference,
        notes: testimonial.notes,
        testimonial_code: testimonial.testimonial_code,
        status: testimonial.status,
        signoff_used_at: testimonial.signoff_used_at,
        approved_at: approvedAt || null, // Use approved_at from approved_testimonials table
        created_at: testimonial.created_at,
        updated_at: testimonial.updated_at,
      },
      userProfile: {
        firstName: userProfile.firstName,
        lastName: userProfile.lastName,
        username: userProfile.username,
        email: userProfile.email || '',
        dateOfBirth: null, // Not available in current user profile
        position: userProfile.position || null,
        dischargeBookNumber: (userProfile as any).discharge_book_number || (userProfile as any).dischargeBookNumber || null,
      },
      vessel: {
        name: vessel.name,
        type: vessel.type || null,
        officialNumber: vessel.officialNumber || null,
        flag_state: vessel.flag_state || null,
        length_m: vessel.length_m || null,
        gross_tonnage: vessel.gross_tonnage || null,
        call_sign: vessel.call_sign || null,
      },
      captainProfile: captainProfile,
      companyDetails: {
        name: (vessel as any).management_company || null,
        address: (vessel as any).company_address || null,
        contactDetails: (vessel as any).company_contact || null,
      },
    }, format);
    } catch (error) {
      console.error('Error generating PDF:', error);
      toast({
        title: 'Error',
        description: 'Failed to generate PDF. Please try again.',
        variant: 'destructive',
      });
    }
  };

  const verifyPasswordAndDelete = async (testimonial: Testimonial) => {
    if (!user?.id || !userProfile?.email || !deletePassword) {
      setPasswordError('Password is required');
      return;
    }

    setIsVerifyingPassword(true);
    isVerifyingRef.current = true;
    setPasswordError('');

    try {
      // Verify password by attempting to sign in
      const { error: signInError } = await supabase.auth.signInWithPassword({
        email: userProfile.email,
        password: deletePassword,
      });

      if (signInError) {
        // Ensure dialog stays open by keeping testimonialToDelete set
        setPasswordError('Incorrect password. Please try again.');
        setIsVerifyingPassword(false);
        isVerifyingRef.current = false;
        // Explicitly ensure testimonialToDelete is still set
        if (!testimonialToDelete) {
          setTestimonialToDelete(testimonial);
        }
        return;
      }

      // Password is correct, proceed with deletion
      // Don't clear password yet - let handleDeleteTestimonial handle cleanup
      await handleDeleteTestimonial(testimonial);
    } catch (error: any) {
      console.error('Error verifying password:', error);
      setPasswordError('An error occurred. Please try again.');
      setIsVerifyingPassword(false);
      isVerifyingRef.current = false;
      // Keep dialog open on error
    }
  };

  const handleDeleteTestimonial = async (testimonial: Testimonial) => {
    if (!user?.id) {
      toast({
        title: 'Error',
        description: 'You must be logged in to delete testimonials.',
        variant: 'destructive',
      });
      return;
    }

    setIsDeleting(true);
    try {
      console.log('Attempting to delete testimonial:', testimonial.id);
      console.log('Current user ID:', user.id);
      
      // Delete the testimonial - RLS will automatically check user_id
      // Using .select() to get confirmation of what was deleted
      const { data: deletedData, error: deleteError } = await supabase
        .from('testimonials')
        .delete()
        .eq('id', testimonial.id)
        .select();

      console.log('Delete response:', { deletedData, deleteError });

      if (deleteError) {
        console.error('Delete error details:', {
          code: deleteError.code,
          message: deleteError.message,
          details: deleteError.details,
          hint: deleteError.hint,
        });
        throw deleteError;
      }

      // Check if anything was actually deleted
      if (!deletedData || deletedData.length === 0) {
        throw new Error('No testimonial was deleted. It may not exist or you may not have permission.');
      }

      console.log('Successfully deleted testimonial:', deletedData);

      // Remove from local state immediately for better UX
      setTestimonials((prev) => prev.filter((t) => t.id !== testimonial.id));

      toast({
        title: 'Testimonial Deleted',
        description: 'The testimonial has been successfully deleted.',
      });

      // Refresh testimonials list to ensure consistency
      const { data: updatedData, error: refreshError } = await supabase
        .from('testimonials')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (refreshError) {
        console.error('Refresh error (non-critical):', refreshError);
      } else if (updatedData) {
        setTestimonials(updatedData as Testimonial[]);
      }

      setTestimonialToDelete(null);
      setDeletePassword('');
      setPasswordError('');
    } catch (error: any) {
      console.error('Error deleting testimonial:', error);
      console.error('Full error object:', JSON.stringify(error, null, 2));
      
      let errorMessage = 'Failed to delete testimonial. Please try again.';
      
      if (error?.message) {
        errorMessage = error.message;
      } else if (error?.code === 'PGRST116') {
        errorMessage = 'No rows were deleted. You may not have permission to delete this testimonial.';
      } else if (error?.code === '42501') {
        errorMessage = 'Permission denied. You do not have permission to delete this testimonial.';
      } else if (error?.code) {
        errorMessage = `Delete failed: ${error.code}. ${error.message || 'Please check the console for details.'}`;
      }

      toast({
        title: 'Error',
        description: errorMessage,
        variant: 'destructive',
      });
    } finally {
      setIsDeleting(false);
    }
  };

  const getStatusBadge = (status: TestimonialStatus) => {
    switch (status) {
      case 'draft':
        return <Badge variant="outline" className="bg-gray-500/10 text-gray-700 dark:text-gray-400 border-gray-500/20"><FileText className="mr-1 h-3 w-3" />Draft</Badge>;
      case 'pending_captain':
        return <Badge variant="outline" className="bg-yellow-500/10 text-yellow-700 dark:text-yellow-400 border-yellow-500/20"><Clock className="mr-1 h-3 w-3" />Pending Captain</Badge>;
      case 'pending_official':
        return <Badge variant="outline" className="bg-blue-500/10 text-blue-700 dark:text-blue-400 border-blue-500/20"><Clock className="mr-1 h-3 w-3" />Pending Official</Badge>;
      case 'approved':
        return <Badge variant="outline" className="bg-green-500/10 text-green-700 dark:text-green-400 border-green-500/20"><CheckCircle2 className="mr-1 h-3 w-3" />Approved</Badge>;
      case 'rejected':
        return <Badge variant="outline" className="bg-red-500/10 text-red-700 dark:text-red-400 border-red-500/20"><XCircle className="mr-1 h-3 w-3" />Rejected</Badge>;
    }
  };

  const isLoading = isLoadingProfile || isLoadingVessels || isLoadingTestimonials;

  // Show loading while checking user profile
  if (isLoadingProfile) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
      </div>
    );
  }

  const currentDocumentType = DOCUMENT_TYPES.find(dt => dt.id === documentType) || DOCUMENT_TYPES[0];
  const DocumentIcon = currentDocumentType.icon;

    return (
    <div className="flex flex-col gap-6">
      {/* Header Section */}
      <div className="space-y-4">
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <div className="space-y-1">
            <h1 className="text-3xl font-bold tracking-tight">Applications</h1>
            <p className="text-muted-foreground">
              Generate testimonials, MCA applications, and other maritime documents.
            </p>
          </div>
        </div>

        {/* Document Type Selector */}
        <TooltipProvider delayDuration={200}>
          <div className="flex flex-wrap gap-2">
            {DOCUMENT_TYPES.map((type) => {
              const Icon = type.icon;
              const isNavWatch = type.id === 'nav_watch_application';
              const isOOW = type.id === 'oow';
              const requiresPremium = (isNavWatch || isOOW) && !hasPremiumAccess;
              const isDisabled = !type.available || requiresPremium;
              
              if (requiresPremium) {
                return (
                  <Tooltip key={type.id} delayDuration={200}>
                    <TooltipTrigger asChild>
                      <div className="inline-block">
                        <Button
                          variant={documentType === type.id ? 'default' : 'outline'}
                          onClick={() => {
                            if (!isDisabled) {
                              setDocumentType(type.id);
                            }
                          }}
                          disabled={isDisabled}
                          className={cn(
                            'rounded-xl transition-all',
                            documentType === type.id && 'bg-primary text-primary-foreground',
                            isDisabled && 'opacity-50 cursor-not-allowed'
                          )}
                        >
                          <Icon className="mr-2 h-4 w-4" />
                          {type.label}
                          <Sparkles className="ml-2 h-4 w-4 text-purple-600 dark:text-purple-400 shrink-0" />
                        </Button>
                      </div>
                    </TooltipTrigger>
                    <TooltipContent side="top" className="max-w-xs z-[100]" sideOffset={8}>
                      <p className="text-sm">
                        {(() => {
                          const role = (userProfile as any)?.role || userProfile?.role || 'crew';
                          return role === 'vessel' 
                            ? 'Upgrade to Premium to use this feature'
                            : 'Upgrade to Premium to use this feature';
                        })()}
                      </p>
                    </TooltipContent>
                  </Tooltip>
                );
              }

              return (
                <Button
                  key={type.id}
                  variant={documentType === type.id ? 'default' : 'outline'}
                  onClick={() => {
                    if (!isDisabled) {
                      setDocumentType(type.id);
                    }
                  }}
                  disabled={isDisabled}
                  className={cn(
                    'rounded-xl transition-all',
                    documentType === type.id && 'bg-primary text-primary-foreground',
                    isDisabled && 'opacity-50 cursor-not-allowed'
                  )}
                >
                  <Icon className="mr-2 h-4 w-4" />
                  {type.label}
                  {!type.available && (
                    <Badge variant="secondary" className="ml-2 text-xs">
                      Coming Soon
                    </Badge>
                  )}
                </Button>
              );
            })}
          </div>
        </TooltipProvider>
      </div>

      {/* Document Type Description */}
      {currentDocumentType && (
        <Card className="border-primary/20 rounded-xl">
          <CardContent className="pt-6">
            <div className="flex items-start gap-4">
              <div className="h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center border border-primary/20 shrink-0">
                <DocumentIcon className="h-5 w-5 text-primary" />
              </div>
              <div className="flex-1">
                <h3 className="font-semibold text-lg mb-1">{currentDocumentType.label}</h3>
                <p className="text-muted-foreground text-sm mb-3">{currentDocumentType.description}</p>
                
                {/* Detailed information based on document type */}
                {documentType === 'testimonial' && (
                  <div className="mt-4 p-4 rounded-lg bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-900/30">
                    <div className="space-y-2 text-sm">
                      <p className="font-medium text-blue-900 dark:text-blue-100">
                        What are Testimonials?
                      </p>
                      <p className="text-blue-700 dark:text-blue-300">
                        Testimonials are official sea service records signed by vessel captains. They document your time served on vessels, 
                        including dates, vessel details, and sea time calculations. These are essential for maritime certification applications.
                      </p>
                      <ul className="list-disc list-inside text-blue-700 dark:text-blue-300 space-y-1 mt-2">
                        <li>Request testimonials from captains via email or their SeaJourney inbox</li>
                        <li>Automatically calculates sea time, standby days, and yard days</li>
                        <li>Approved testimonials can be used for MCA applications</li>
                        <li>Download PDF testimonials for your records</li>
                      </ul>
                    </div>
                  </div>
                )}
                
                {documentType === 'nav_watch_application' && (
                  <div className="mt-4 p-4 rounded-lg bg-purple-50 dark:bg-purple-950/20 border border-purple-200 dark:border-purple-900/30">
                    <div className="space-y-2 text-sm">
                      <p className="font-medium text-purple-900 dark:text-purple-100">
                        MCA Watch Rating Certificate Application (MSF 4371)
                      </p>
                      <p className="text-purple-700 dark:text-purple-300">
                        Generate official MCA Watch Rating Certificate applications for Navigational, Engine Room, or Electro-Technical ratings. 
                        This form is used to apply for a Notice of Eligibility (NOE) for an oral examination.
                      </p>
                      <ul className="list-disc list-inside text-purple-700 dark:text-purple-300 space-y-1 mt-2">
                        <li>Automatically includes all sea time from approved testimonials</li>
                        <li>Personal details auto-populated from your profile</li>
                        <li>Official MCA PDF format ready for submission</li>
                        <li>Supports Navigational (II/4), Engine Room (III/4), and Electro-Technical (III/7) certificates</li>
                        <li>Includes document checklists and declaration signature</li>
                      </ul>
                    </div>
                  </div>
                )}
                
                {documentType === 'oow' && (
                  <div className="mt-4 p-4 rounded-lg bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-900/30">
                    <div className="space-y-2 text-sm">
                      <p className="font-medium text-green-900 dark:text-green-100">
                        MCA Officer of the Watch (OOW) Application (MSF 4274)
                      </p>
                      <p className="text-green-700 dark:text-green-300">
                        Generate official MCA applications for Officer of the Watch (OOW), Chief Mate, and Master certificates. 
                        This form is used to apply for a Notice of Eligibility (NOE) for an oral examination leading to a Certificate of Competency.
                      </p>
                      <ul className="list-disc list-inside text-green-700 dark:text-green-300 space-y-1 mt-2">
                        <li>Automatically includes all sea service from approved testimonials</li>
                        <li>Personal details and addresses auto-populated from your profile</li>
                        <li>Official MCA PDF format (MSF 4274 Rev 01/26) ready for submission</li>
                        <li>Supports OOW, Chief Mate, and Master certificates at various tonnage levels</li>
                        <li>Includes sea service table, certificate details, and declaration signature</li>
                      </ul>
                    </div>
                  </div>
                )}
                
                {documentType === 'custom' && (
                  <div className="mt-4 p-4 rounded-lg bg-orange-50 dark:bg-orange-950/20 border border-orange-200 dark:border-orange-900/30">
                    <div className="space-y-2 text-sm">
                      <p className="font-medium text-orange-900 dark:text-orange-100">
                        Custom Documents
                      </p>
                      <p className="text-orange-700 dark:text-orange-300">
                        Create custom maritime documents tailored to your specific needs. This feature is coming soon.
                      </p>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Conditional Content Based on Document Type */}
      {documentType === 'testimonial' && (
        <>
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div className="space-y-1">
              <h2 className="text-2xl font-semibold tracking-tight">Testimonials</h2>
              <p className="text-muted-foreground">
                Request testimonials from vessel captains and view your testimonial requests.
              </p>
            </div>
            <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
              <DialogTrigger asChild>
                <Button className="rounded-xl">
                  <PlusCircle className="mr-2 h-4 w-4" />
                  Request Testimonial
                </Button>
              </DialogTrigger>
              <DialogContent className="rounded-xl max-w-5xl max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                  <DialogTitle>Request Testimonial</DialogTitle>
                </DialogHeader>
              <Form {...form}>
                <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-6">
                  {/* Main Content Grid */}
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* Left Column: Vessel & Captain Info */}
                    <div className="lg:col-span-1 space-y-4">
                      {/* Show current vessel info if available */}
                      {currentVessel && !useDifferentVessel && (
                        <Card className="border-primary/30 bg-gradient-to-br from-primary/5 to-primary/10">
                          <CardContent className="pt-4">
                            <div className="space-y-3">
                              <div className="flex items-center gap-2">
                                <div className="h-8 w-8 rounded-lg bg-primary/20 flex items-center justify-center border border-primary/30 shrink-0">
                                  <Ship className="h-4 w-4 text-primary" />
                                </div>
                                <div className="flex-1 min-w-0">
                                  <h3 className="text-xs font-semibold text-muted-foreground">Current Vessel</h3>
                                  <p className="text-sm font-medium mt-0.5">{currentVessel.name}</p>
                                  <p className="text-xs text-muted-foreground mt-0.5">
                                    {currentVessel.type}  {currentVessel.officialNumber || 'No IMO'}
                                  </p>
                                </div>
                              </div>
                              
                              {/* Captain Info */}
                              <div className="pt-3 border-t border-primary/20">
                                {isCheckingCaptain ? (
                                  <div className="flex items-center gap-2 text-xs text-muted-foreground">
                                    <Loader2 className="h-3 w-3 animate-spin" />
                                    <span>Checking...</span>
                                  </div>
                                ) : availableCaptains.length > 0 ? (
                                  // Show captain info (auto-selected, allow change if multiple)
                                  <div className="space-y-2">
                                    <Badge variant="outline" className="text-xs bg-green-500/10 text-green-700 border-green-500/20 dark:bg-green-500/20 dark:text-green-400">
                                      <CheckCircle2 className="h-3 w-3 mr-1" />
                                      {availableCaptains.length === 1 
                                        ? 'Active Captain' 
                                        : `${availableCaptains.length} Captains`}
                                    </Badge>
                                    
                                    {availableCaptains.length === 1 ? (
                                      // Single captain - just show info
                                      <div className="p-2.5 rounded-lg border border-primary/20 bg-primary/5 dark:bg-primary/10">
                                        <div className="flex items-center gap-2">
                                          <Ship className="h-3.5 w-3.5 text-primary" />
                                          <div className="flex-1 min-w-0">
                                            {availableCaptains[0].name && (
                                              <div className="font-medium text-xs">
                                                {availableCaptains[0].name}
                                              </div>
                                            )}
                                            {availableCaptains[0].email && (
                                              <div className="text-[10px] text-muted-foreground mt-0.5 truncate">
                                                {availableCaptains[0].email}
                                              </div>
                                            )}
                                          </div>
                                        </div>
                                      </div>
                                    ) : (
                                      // Multiple captains - allow selection
                                      <div className="space-y-1.5">
                                        {availableCaptains.map((captain) => (
                                          <div
                                            key={captain.id}
                                            onClick={() => setActiveCaptain({ id: captain.id })}
                                            className={`p-2.5 rounded-lg border cursor-pointer transition-all ${
                                              activeCaptain?.id === captain.id
                                                ? 'border-primary bg-primary/5 dark:bg-primary/10'
                                                : 'border-border hover:border-primary/50 hover:bg-muted/50'
                                            }`}
                                          >
                                            <div className="flex items-start justify-between gap-2">
                                              <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-1.5">
                                                  <Ship className="h-3.5 w-3.5 text-primary shrink-0" />
                                                  {captain.name && (
                                                    <span className="font-medium text-xs">
                                                      {captain.name}
                                                    </span>
                                                  )}
                                                </div>
                                                {captain.email && (
                                                  <div className="text-[10px] text-muted-foreground mt-0.5 truncate">
                                                    {captain.email}
                                                  </div>
                                                )}
                                              </div>
                                              <div className={`h-3.5 w-3.5 rounded-full border-2 flex items-center justify-center shrink-0 ${
                                                activeCaptain?.id === captain.id
                                                  ? 'border-primary bg-primary'
                                                  : 'border-muted-foreground/30'
                                              }`}>
                                                {activeCaptain?.id === captain.id && (
                                                  <CheckCircle2 className="h-2.5 w-2.5 text-primary-foreground" />
                                                )}
                                              </div>
                                            </div>
                                          </div>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                ) : (
                                  <div className="text-xs text-muted-foreground">
                                    <Badge variant="outline" className="text-xs">
                                      No active captain
                                    </Badge>
                                    <p className="mt-1 text-[10px]">Enter email manually</p>
                                  </div>
                                )}
                              </div>
                            </div>
                          </CardContent>
                        </Card>
                      )}

                      {/* Option to select different vessel */}
                      {currentVessel && (
                        <div className="flex items-center space-x-2">
                          <Checkbox
                            id="use-different-vessel"
                            checked={useDifferentVessel}
                            onCheckedChange={(checked) => {
                              setUseDifferentVessel(checked as boolean);
                              if (!checked && currentVessel) {
                                form.setValue('vessel_id', currentVessel.id, { shouldValidate: false });
                              } else {
                                form.setValue('vessel_id', '', { shouldValidate: false });
                              }
                            }}
                          />
                          <label
                            htmlFor="use-different-vessel"
                            className="text-xs font-medium leading-none cursor-pointer"
                          >
                            Select different vessel
                          </label>
                        </div>
                      )}

                      {/* Vessel selector */}
                      <FormField
                        control={form.control}
                        name="vessel_id"
                        render={({ field }) => (
                          <FormItem className={currentVessel && !useDifferentVessel ? 'sr-only' : ''}>
                            <FormLabel className="text-xs">Vessel</FormLabel>
                            <FormControl>
                              <SearchableSelect
                                options={vessels.map(vessel => ({
                                  value: vessel.id,
                                  label: vessel.name,
                                }))}
                                value={field.value || ''}
                                onValueChange={field.onChange}
                                placeholder="Select a vessel..."
                              />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>

                    {/* Right Column: Form Fields */}
                    <div className="lg:col-span-2 space-y-4">
                      {/* Quick Date Range Options */}
                      {watchedVesselId && (
                        <div className="space-y-2">
                          <FormLabel className="text-sm font-semibold">Quick Select Date Range</FormLabel>
                          {dateRangeOptions && dateRangeOptions.length > 0 ? (
                            <div className="grid grid-cols-2 gap-2">
                              {dateRangeOptions.map((option, index) => {
                                const daysDiff = differenceInDays(option.endDate, option.startDate) + 1;
                                return (
                                  <button
                                    key={index}
                                    type="button"
                                    onClick={() => applyDateRangeOption(option)}
                                    className="group relative rounded-lg border border-border bg-card p-3 text-left hover:border-primary hover:bg-accent transition-all"
                                  >
                                    <div className="flex items-start justify-between gap-2">
                                      <div className="flex-1 min-w-0">
                                        <div className="font-semibold text-xs mb-1 group-hover:text-primary transition-colors">
                                          {option.label}
                                        </div>
                                        <div className="flex flex-col gap-0.5 text-[10px] text-muted-foreground">
                                          <span>{format(option.startDate, 'MMM d, yyyy')}</span>
                                          <span>{format(option.endDate, 'MMM d, yyyy')}</span>
                                        </div>
                                      </div>
                                      <div className="flex-shrink-0 text-right">
                                        <div className="text-base font-bold text-primary">
                                          {daysDiff}
                                        </div>
                                        <div className="text-[10px] text-muted-foreground">
                                          {daysDiff === 1 ? 'day' : 'days'}
                                        </div>
                                      </div>
                                    </div>
                                  </button>
                                );
                              })}
                            </div>
                          ) : selectedVesselLogs.length === 0 ? (
                            <div className="rounded-lg border border-dashed p-3 text-center">
                              <p className="text-xs text-muted-foreground">Loading vessel data...</p>
                            </div>
                          ) : (
                            <div className="rounded-lg border border-dashed p-3 text-center">
                              <p className="text-xs text-muted-foreground">No date range options available.</p>
                            </div>
                          )}
                        </div>
                      )}

                      <div className="grid grid-cols-2 gap-3">
                    <FormField
                      control={form.control}
                      name="start_date"
                      render={({ field }) => (
                        <FormItem className="flex flex-col">
                          <FormLabel>Start Date</FormLabel>
                          <Popover>
                            <PopoverTrigger asChild>
                              <FormControl>
                                <Button
                                  variant="outline"
                                  className={cn(
                                    "w-full rounded-xl justify-start text-left font-normal",
                                    !field.value && "text-muted-foreground"
                                  )}
                                >
                                  <CalendarIcon className="mr-2 h-4 w-4" />
                                  {field.value ? format(field.value, 'PPP') : 'Pick a date'}
                                </Button>
                              </FormControl>
                            </PopoverTrigger>
                            <PopoverContent className="w-auto p-0" align="start">
                              <CalendarComponent
                                mode="single"
                                selected={field.value}
                                onSelect={field.onChange}
                                disabled={(date) => isAfter(date, startOfDay(new Date()))}
                                initialFocus
                              />
                            </PopoverContent>
                          </Popover>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="end_date"
                      render={({ field }) => (
                        <FormItem className="flex flex-col">
                          <FormLabel>End Date</FormLabel>
                          <Popover>
                            <PopoverTrigger asChild>
                              <FormControl>
                                <Button
                                  variant="outline"
                                  className={cn(
                                    "w-full rounded-xl justify-start text-left font-normal",
                                    !field.value && "text-muted-foreground"
                                  )}
                                >
                                  <CalendarIcon className="mr-2 h-4 w-4" />
                                  {field.value ? format(field.value, 'PPP') : 'Pick a date'}
                                </Button>
                              </FormControl>
                            </PopoverTrigger>
                            <PopoverContent className="w-auto p-0" align="start">
                              <CalendarComponent
                                mode="single"
                                selected={field.value}
                                onSelect={field.onChange}
                                disabled={(date) => isAfter(date, startOfDay(new Date())) || (form.watch('start_date') && date < form.watch('start_date'))}
                                initialFocus
                              />
                            </PopoverContent>
                          </Popover>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
            </div>

                      {/* Day Counts Preview */}
                      {dayCountsPreview && (
                        <div className="p-3 bg-muted/50 rounded-lg border">
                          <div className="text-xs font-medium mb-2">Service Summary</div>
                          <div className="grid grid-cols-5 gap-2 text-xs">
                            <div>
                              <div className="text-muted-foreground text-[10px]">Total</div>
                              <div className="font-semibold">{dayCountsPreview.total_days}</div>
                            </div>
                            <div>
                              <div className="text-muted-foreground text-[10px]">At Sea</div>
                              <div className="font-semibold">{dayCountsPreview.at_sea_days}</div>
                            </div>
                            <div>
                              <div className="text-muted-foreground text-[10px]">Standby</div>
                              <div className="font-semibold">{dayCountsPreview.standby_days}</div>
                            </div>
                            <div>
                              <div className="text-muted-foreground text-[10px]">Yard</div>
                              <div className="font-semibold">{dayCountsPreview.yard_days}</div>
                            </div>
                            <div>
                              <div className="text-muted-foreground text-[10px]">Leave</div>
                              <div className="font-semibold">{dayCountsPreview.leave_days}</div>
                            </div>
                          </div>
                        </div>
                      )}

                      {/* Only show captain email field if no active captain found */}
                      {!activeCaptain && !isCheckingCaptain && (
                        <FormField
                          control={form.control}
                          name="captain_email"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel className="text-xs">Captain Email (Optional)</FormLabel>
                              <FormControl>
                                <Input
                                  type="email"
                                  placeholder="captain@vessel.com"
                                  className="rounded-lg h-9"
                                  {...field}
                                />
                              </FormControl>
                              <FormDescription className="text-xs">
                                Enter captain email if no active captain found.
                              </FormDescription>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      )}
                    </div>
                  </div>


                  <DialogFooter>
                    <Button
                      type="button"
                      variant="outline"
                      onClick={() => {
                        form.reset();
                        setActiveCaptain(null);
      setAvailableCaptains([]);
                        setIsDialogOpen(false);
                      }}
                      className="rounded-xl"
                    >
                      Cancel
                    </Button>
                    <Button
                      type="submit"
                      disabled={isSaving}
                      className="rounded-xl"
                    >
                      {isSaving ? (
                        <>
                          <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                          Saving...
                        </>
                      ) : (
                        <>
                          {activeCaptain ? (
                            <>
                              <Mail className="mr-2 h-4 w-4" />
                              Send to Captain's Inbox
                            </>
                          ) : form.watch('captain_email') ? (
                            <>
                              <Mail className="mr-2 h-4 w-4" />
                              Send Request
                            </>
                          ) : (
                            'Save as Draft'
                          )}
                        </>
                      )}
                    </Button>
                  </DialogFooter>
                </form>
              </Form>
              </DialogContent>
            </Dialog>
          </div>
          <Separator />

          {/* Testimonials Table */}
      {isLoading ? (
        <div className="flex items-center justify-center py-12">
          <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
                                </div>
      ) : (
        <Card className="rounded-xl border">
          <CardHeader>
            <CardTitle>Testimonial Requests</CardTitle>
                            </CardHeader>
                            <CardContent>
            <Tabs value={activeTab} onValueChange={(value) => setActiveTab(value as any)} className="w-full">
              <TabsList className="grid w-full grid-cols-5 mb-6 rounded-xl">
                <TabsTrigger value="all">All</TabsTrigger>
                <TabsTrigger value="draft">Draft</TabsTrigger>
                <TabsTrigger value="pending">Pending</TabsTrigger>
                <TabsTrigger value="approved">Approved</TabsTrigger>
                <TabsTrigger value="rejected">Rejected</TabsTrigger>
              </TabsList>
              <TabsContent value={activeTab} className="mt-0">
                {filteredTestimonials.length === 0 ? (
                  <div className="flex flex-col items-center justify-center py-12 ">
                    <LifeBuoy className="h-12 w-12 text-muted-foreground mb-4 " />
                    <h3 className="text-lg font-semibold mb-2">No Testimonials</h3>
                    <p className="text-sm text-muted-foreground text-center max-w-md">
                      {activeTab === 'all' 
                        ? "You haven't created any testimonials yet. Click \"Request Testimonial\" to get started."
                        : `You don't have any ${activeTab} testimonials.`}
                    </p>
                  </div>
                ) : (
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>Vessel</TableHead>
                        <TableHead>Date Range</TableHead>
                        <TableHead>Days</TableHead>
                        <TableHead>Captain</TableHead>
                        <TableHead>Status</TableHead>
                        <TableHead>Created</TableHead>
                        <TableHead>PDF</TableHead>
                        <TableHead className="w-[100px]">Actions</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {filteredTestimonials.map((testimonial) => {
                        const isExpanded = expandedTestimonials.has(testimonial.id);
                        const hasRejectionMessage = testimonial.status === 'rejected' && testimonial.notes;
                        
                        // Extract rejection reason from notes
                        let rejectionReason = '';
                        if (testimonial.notes) {
                          if (testimonial.notes.includes('Rejection reason:')) {
                            rejectionReason = testimonial.notes.split('Rejection reason:')[1]?.trim() || '';
                          } else {
                            // If no prefix, use the whole notes field
                            rejectionReason = testimonial.notes;
                          }
                        }
                        
                        return (
                          <React.Fragment key={testimonial.id}>
                            <TableRow>
                              <TableCell className="font-medium">
                                <div className="flex items-center gap-2">
                                  <Ship className="h-4 w-4 text-muted-foreground" />
                                  {getVesselName(testimonial.vessel_id)}
                                </div>
                              </TableCell>
                              <TableCell>
                                <div className="flex items-center gap-2 text-sm">
                                  <Calendar className="h-4 w-4 text-muted-foreground" />
                                  {format(new Date(testimonial.start_date), 'MMM d, yyyy')} - {format(new Date(testimonial.end_date), 'MMM d, yyyy')}
                                </div>
                              </TableCell>
                              <TableCell>
                                <div className="text-sm">
                                  <div className="font-medium">{testimonial.total_days} total</div>
                                  <div className="text-muted-foreground text-xs">
                                    {testimonial.at_sea_days} at sea, {testimonial.standby_days} standby
                                  </div>
                                </div>
                              </TableCell>
                              <TableCell>
                                {testimonial.captain_user_id || testimonial.captain_email ? (
                                  <div className="flex items-center gap-2">
                                    {testimonial.captain_user_id ? (
                                      <Ship className="h-4 w-4 text-primary" />
                                    ) : (
                                    <Mail className="h-4 w-4 text-muted-foreground" />
                                    )}
                                    <div>
                                      {testimonial.captain_name ? (
                                        <div className="font-medium text-sm">{testimonial.captain_name}</div>
                                      ) : null}
                                      {testimonial.captain_email ? (
                                        <div className="text-sm text-muted-foreground">{testimonial.captain_email}</div>
                                      ) : testimonial.captain_user_id && !testimonial.captain_name ? (
                                        <div className="text-xs text-muted-foreground italic">Captain profile unavailable</div>
                                      ) : null}
                                    </div>
                                  </div>
                                ) : (
                                  <span className="text-sm text-muted-foreground"></span>
                                )}
                              </TableCell>
                              <TableCell>
                                <div className="flex items-center gap-2">
                                  {getStatusBadge(testimonial.status)}
                                  {hasRejectionMessage && (
                                    <Button
                                      variant="ghost"
                                      size="sm"
                                      onClick={() => {
                                        const newExpanded = new Set(expandedTestimonials);
                                        if (newExpanded.has(testimonial.id)) {
                                          newExpanded.delete(testimonial.id);
                                        } else {
                                          newExpanded.add(testimonial.id);
                                        }
                                        setExpandedTestimonials(newExpanded);
                                      }}
                                      className="h-6 w-6 p-0"
                                    >
                                      {isExpanded ? (
                                        <ChevronUp className="h-4 w-4" />
                                      ) : (
                                        <ChevronDown className="h-4 w-4" />
                                      )}
                                    </Button>
                                  )}
                                </div>
                              </TableCell>
                              <TableCell className="text-sm text-muted-foreground">
                                {format(new Date(testimonial.created_at), 'MMM d, yyyy')}
                              </TableCell>
                              <TableCell>
                                {testimonial.pdf_url ? (
                                  <a 
                                    href={testimonial.pdf_url} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="text-primary hover:underline text-sm"
                                  >
                                    View PDF
                                  </a>
                                ) : testimonial.status === 'approved' ? (
                                  <DropdownMenu>
                                    <DropdownMenuTrigger asChild>
                                  <Button
                                    variant="outline"
                                    size="sm"
                                    className="rounded-xl"
                                  >
                                    <Download className="mr-2 h-4 w-4" />
                                        Download PDF
                                        <ChevronDown className="ml-2 h-4 w-4" />
                                  </Button>
                                    </DropdownMenuTrigger>
                                    <DropdownMenuContent align="end">
                                      <DropdownMenuItem onClick={() => handleGeneratePDF(testimonial, 'mca')}>
                                        <FileText className="mr-2 h-4 w-4" />
                                        MCA Format
                                      </DropdownMenuItem>
                                      <DropdownMenuItem onClick={() => handleGeneratePDF(testimonial, 'seajourney')}>
                                        <FileText className="mr-2 h-4 w-4" />
                                        SeaJourney Format
                                      </DropdownMenuItem>
                                    </DropdownMenuContent>
                                  </DropdownMenu>
                                ) : (
                                  <span className="text-sm text-muted-foreground"></span>
                                )}
                              </TableCell>
                              <TableCell>
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  onClick={() => setTestimonialToDelete(testimonial)}
                                  className="rounded-xl text-destructive hover:text-destructive hover:bg-destructive/10"
                                >
                                  <Trash2 className="h-4 w-4" />
                                </Button>
                              </TableCell>
                            </TableRow>
                            {isExpanded && hasRejectionMessage && (
                              <TableRow>
                                <TableCell colSpan={8} className="bg-red-50 dark:bg-red-950/20 p-0">
                                  <div className="p-4 space-y-3">
                                    <div className="flex items-start gap-3">
                                      <AlertCircle className="h-5 w-5 text-red-600 dark:text-red-400 mt-0.5 flex-shrink-0" />
                                      <div className="flex-1 space-y-3">
                                        <div>
                                          <div className="font-semibold text-sm text-red-900 dark:text-red-100 mb-2">
                                            Rejection Details
                                          </div>
                                          <div className="text-sm text-red-800 dark:text-red-200 whitespace-pre-wrap bg-white dark:bg-gray-900 p-4 rounded-lg border border-red-200 dark:border-red-800 max-h-96 overflow-y-auto">
                                            {rejectionReason.split('--- State Mismatches Found ---').map((section, idx) => {
                                              if (idx === 0) {
                                                // Main rejection reason
                                                return section.trim() ? (
                                                  <div key={idx} className="mb-4">
                                                    <div className="font-medium mb-2">Reason:</div>
                                                    <div className="text-red-900 dark:text-red-100">{section.trim()}</div>
                                                  </div>
                                                ) : null;
                                              } else {
                                                // Mismatch details section
                                                const mismatchParts = section.split('\n').filter(line => line.trim());
                                                return (
                                                  <div key={idx} className="mt-4 pt-4 border-t border-red-200 dark:border-red-800">
                                                    <div className="font-medium mb-3 text-red-900 dark:text-red-100">
                                                      State Mismatches Found
                                                    </div>
                                                    <div className="space-y-2 text-sm">
                                                      {mismatchParts.map((line, lineIdx) => {
                                                        if (line.includes('Total mismatches:')) {
                                                          return (
                                                            <div key={lineIdx} className="font-semibold text-red-900 dark:text-red-100 mb-2">
                                                              {line}
                                                            </div>
                                                          );
                                                        } else if (line.match(/^\d+\./)) {
                                                          // Mismatch line
                                                          return (
                                                            <div key={lineIdx} className="text-red-800 dark:text-red-200 pl-4">
                                                              {line}
                                                            </div>
                                                          );
                                                        } else if (line.includes('more mismatch')) {
                                                          return (
                                                            <div key={lineIdx} className="text-red-700 dark:text-red-300 italic pl-4">
                                                              {line}
                                                            </div>
                                                          );
                                                        } else if (line.trim() && !line.includes('Please review')) {
                                                          return (
                                                            <div key={lineIdx} className="text-red-800 dark:text-red-200">
                                                              {line}
                                                            </div>
                                                          );
                                                        } else if (line.includes('Please review')) {
                                                          return (
                                                            <div key={lineIdx} className="mt-3 pt-3 border-t border-red-200 dark:border-red-800 text-red-900 dark:text-red-100 font-medium">
                                                              {line}
                                                            </div>
                                                          );
                                                        }
                                                        return null;
                                                      })}
                                                    </div>
                                                  </div>
                                                );
                                              }
                                            })}
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </TableCell>
                              </TableRow>
                            )}
                          </React.Fragment>
                        );
                      })}
                    </TableBody>
                  </Table>
                )}
              </TabsContent>
            </Tabs>
                            </CardContent>
                        </Card>
            )}
      </>
      )}

      {/* OOW Application Form */}
            {documentType === 'oow' && hasPremiumAccess && (
              <>
                  <div className="text-center py-12">
                    <p className="text-muted-foreground mb-6">
                      Generate OOW (Officer of the Watch) application documents.
                    </p>
                    <Dialog open={isOowDialogOpen} onOpenChange={setIsOowDialogOpen}>
                  <DialogTrigger asChild>
                    <Button className="rounded-xl">
                      <PlusCircle className="mr-2 h-4 w-4" />
                      Generate OOW Application
                    </Button>
                  </DialogTrigger>
                  <DialogContent className="rounded-xl max-w-4xl max-h-[90vh] overflow-y-auto">
                    <DialogHeader>
                      <DialogTitle>OOW Application (MSF 4274)</DialogTitle>
                    </DialogHeader>
                    <Form {...oowForm}>
                      <form onSubmit={oowForm.handleSubmit(handleOowSubmit)} className="space-y-6">
                        {/* Info Banner */}
                        <div className="p-4 rounded-lg bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-900/30">
                          <div className="flex items-start gap-3">
                            <Info className="h-5 w-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0" />
                            <div className="space-y-1">
                              <p className="text-sm font-medium text-blue-900 dark:text-blue-100">
                                Automatic Sea Service Records
                              </p>
                              <p className="text-xs text-blue-700 dark:text-blue-300">
                                This application will automatically include all sea time from all vessels you have served on, 
                                based on your approved testimonials. Personal details will be populated from your profile.
                              </p>
                            </div>
                          </div>
                        </div>

                        {/* Certificate Type Selection */}
                        <FormField
                          control={oowForm.control}
                          name="certificate_type"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Certificate Applied For *</FormLabel>
                              <Select onValueChange={field.onChange} value={field.value}>
                                <FormControl>
                                  <SelectTrigger className="rounded-xl">
                                    <SelectValue placeholder="Select certificate type" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value="ii3_oow_lt500gt_d">II/3 OOW, Less than 500GT, Category "D" Waters</SelectItem>
                                  <SelectItem value="ii3_oow_lt500gt_nc">II/3 OOW, Less than 500GT, Near Coastal Waters</SelectItem>
                                  <SelectItem value="ii1_oow_unlimited">II/1 OOW, Unlimited Tonnage, Unlimited Area</SelectItem>
                                  <SelectItem value="ii2_cm_lt3000gt_nc">II/2 Chief Mate, Less than 3000GT, Near Coastal Waters</SelectItem>
                                  <SelectItem value="ii2_cm_lt3000gt_unlimited">II/2 Chief Mate, Less than 3000GT, Unlimited Area</SelectItem>
                                  <SelectItem value="ii2_cm_unlimited_nc">II/2 Chief Mate, Unlimited Tonnage, Near Coastal Waters</SelectItem>
                                  <SelectItem value="ii2_cm_unlimited_unlimited">II/2 Chief Mate, Unlimited Tonnage, Unlimited Area</SelectItem>
                                  <SelectItem value="ii3_master_lt500gt_d">II/3 Master, Less than 500GT, Category "D" Waters</SelectItem>
                                  <SelectItem value="ii3_master_lt500gt_nc">II/3 Master, Less than 500GT, Near Coastal Waters</SelectItem>
                                  <SelectItem value="ii2_master_lt3000gt_specified">II/2 Master, Less than 3000GT, Specified Area, Domestic Vessels Only</SelectItem>
                                  <SelectItem value="ii2_master_lt3000gt_unlimited">II/2 Master, Less than 3000GT, Unlimited Area</SelectItem>
                                  <SelectItem value="ii2_master_unlimited_nc">II/2 Master, Unlimited Tonnage, Near Coastal Waters</SelectItem>
                                  <SelectItem value="ii2_master_unlimited_unlimited">II/2 Master, Unlimited Tonnage, Unlimited Area</SelectItem>
                                </SelectContent>
                              </Select>
                              <FormDescription>
                                Select the certificate you are applying for
                              </FormDescription>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        {/* Section 10: Declaration Signature */}
                        <div className="space-y-4 pt-6 border-t">
                          <h3 className="text-lg font-semibold">Section 10: Declaration</h3>
                          <p className="text-sm text-muted-foreground">
                            Please sign the declaration. Your signature will appear on the certificate.
                          </p>
                          <FormField
                            control={oowForm.control}
                            name="signatureDataUrl"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Signature</FormLabel>
                                <FormControl>
                                  <SignaturePad
                                    value={field.value}
                                    onChange={field.onChange}
                                  />
                                </FormControl>
                                <FormDescription>
                                  Draw or upload your signature
                                </FormDescription>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                        </div>

                        <DialogFooter className="gap-2 sm:gap-0">
                          <Button
                            type="button"
                            variant="outline"
                            onClick={() => setIsOowDialogOpen(false)}
                            className="rounded-xl"
                          >
                            Cancel
                          </Button>
                          <Button
                            type="submit"
                            disabled={isSaving}
                            className="rounded-xl text-white dark:text-white"
                          >
                            {isSaving ? (
                              <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                Generating...
                              </>
                            ) : (
                              <>
                                <FileText className="mr-2 h-4 w-4" />
                                Generate PDF
                              </>
                            )}
                          </Button>
                        </DialogFooter>
                      </form>
                    </Form>
                  </DialogContent>
                </Dialog>
              </div>
              </>
            )}

      {documentType === 'nav_watch_application' && hasPremiumAccess && (
        <>
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div className="space-y-1">
              <h2 className="text-2xl font-semibold tracking-tight">Nav Watch Application</h2>
              <p className="text-muted-foreground">
                Generate navigation watch application documents.
              </p>
            </div>
            <Dialog open={isNavWatchDialogOpen} onOpenChange={setIsNavWatchDialogOpen}>
              <DialogTrigger asChild>
                <Button className="rounded-xl">
                  <PlusCircle className="mr-2 h-4 w-4" />
                  Generate Nav Watch Application
                </Button>
              </DialogTrigger>
              <DialogContent className="rounded-xl max-w-5xl max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                  <DialogTitle>Nav Watch Application</DialogTitle>
                </DialogHeader>
                <Form {...navWatchForm}>
                  <form onSubmit={navWatchForm.handleSubmit(handleNavWatchSubmit)} className="space-y-6">
                    {/* Info Banner */}
                    <div className="p-4 rounded-lg bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-900/30">
                      <div className="flex items-start gap-3">
                        <Info className="h-5 w-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0" />
                        <div className="space-y-1">
                          <p className="text-sm font-medium text-blue-900 dark:text-blue-100">
                            Automatic Sea Service Records
                          </p>
                          <p className="text-xs text-blue-700 dark:text-blue-300">
                            This application will automatically include all sea time from all vessels you have served on, 
                            based on your approved testimonials and vessel assignments. No need to select vessels or dates manually.
                          </p>
                        </div>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Certificate Type Selection */}
                      <FormField
                        control={navWatchForm.control}
                        name="certificate_type"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Certificate Applied For *</FormLabel>
                            <Select onValueChange={field.onChange} value={field.value}>
                            <FormControl>
                                <SelectTrigger className="rounded-xl">
                                  <SelectValue placeholder="Select certificate type" />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                <SelectItem value="navigational_ii4">
                                  Navigational Watch Rating Certificate II/4
                                </SelectItem>
                                <SelectItem value="navigational_iii4">
                                  Engine Room Watch Rating Certificate III/4
                                </SelectItem>
                                <SelectItem value="electro_technical">
                                  Electro-technical Rating III/7
                                </SelectItem>
                              </SelectContent>
                            </Select>
                            <FormDescription>
                              Select the certificate you are applying for
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      {/* Watchkeeping Hours */}
                      <FormField
                        control={navWatchForm.control}
                        name="watchkeeping_hours"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Watchkeeping Hours</FormLabel>
                            <FormControl>
                              <Input
                                type="number"
                                placeholder="e.g., 240"
                                {...field}
                                onChange={(e) => field.onChange(e.target.value ? parseFloat(e.target.value) : undefined)}
                                className="rounded-xl"
                              />
                            </FormControl>
                            <FormDescription>
                              Total hours of watchkeeping duties performed
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                    </div>

                    {/* Section 4: Checklist - Only for Navigational and Engine Room */}
                    {navWatchForm.watch('certificate_type') !== 'electro_technical' && (
                      <div className="space-y-4 pt-6 border-t">
                      <h3 className="text-lg font-semibold">Section 4: Documents Checklist</h3>
                      <p className="text-sm text-muted-foreground">
                        Please check all documents you are submitting with this application:
                      </p>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <FormField
                          control={navWatchForm.control}
                          name="checklist.attestedPassport"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                                  <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Attested Passport
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklist.payment"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Payment
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklist.dischargeBookOrCd"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                                  </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Discharge Book or CD
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklist.seaServiceTestimonials"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Sea Service Testimonials
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklist.passportPhoto"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                                  <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Passport Photo
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklist.stcwBasicTraining"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  STCW Basic Training
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklist.securityAwareness"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                                  </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Security Awareness (STCW A-VI/6)
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklist.profInSurvivalCraft"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Proficiency in Survival Craft (STCW A-VI/2-1)
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklist.medical"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Medical Certificate
                                </FormLabel>
                      </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklist.watchRatingTrainingRecordBook"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Watch Rating Training Record Book
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklist.mntb"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  MNTB (if relevant)
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                      </div>
                      </div>
                    )}

                    {/* Section 5: ETR Checklist - Only for Electro-technical */}
                    {navWatchForm.watch('certificate_type') === 'electro_technical' && (
                      <div className="space-y-4 pt-6 border-t">
                      <h3 className="text-lg font-semibold">Section 5: ETR Documents Checklist</h3>
                      <p className="text-sm text-muted-foreground">
                        Please check all documents you are submitting with this application:
                      </p>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <FormField
                          control={navWatchForm.control}
                          name="checklistETR.attestedPassport"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Attested Passport
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklistETR.payment"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Payment
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklistETR.dischargeBookOrCd"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Discharge Book or CD
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklistETR.seaServiceTestimonials"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Sea Service Testimonials
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklistETR.passportPhoto"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Passport Photo
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklistETR.stcwBasicTraining"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  STCW Basic Training
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklistETR.securityAwareness"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Security Awareness (STCW A-VI/6)
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklistETR.electroTechnicalTraining"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Electro-technical Training
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklistETR.medical"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Medical Certificate
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="checklistETR.electroTechnicalRecordBook"
                          render={({ field }) => (
                            <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                              <FormControl>
                                <Checkbox
                                  checked={field.value}
                                  onCheckedChange={field.onChange}
                                />
                              </FormControl>
                              <div className="space-y-1 leading-none">
                                <FormLabel className="text-sm font-normal cursor-pointer">
                                  Electro-technical Record Book
                                </FormLabel>
                              </div>
                            </FormItem>
                          )}
                        />
                      </div>
                      </div>
                    )}

                    {/* Checkbox to include countersign section */}
                    <div className="space-y-4 pt-6 border-t">
                      <FormField
                        control={navWatchForm.control}
                        name="includeCountersign"
                        render={({ field }) => (
                          <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                            <FormControl>
                              <Checkbox
                                checked={field.value}
                                onCheckedChange={field.onChange}
                              />
                            </FormControl>
                            <div className="space-y-1 leading-none">
                              <FormLabel className="text-sm font-normal cursor-pointer">
                                Include Countersign Section
                              </FormLabel>
                              <FormDescription className="text-xs text-muted-foreground">
                                Check this box if someone will be countersigning this application
                              </FormDescription>
                            </div>
                          </FormItem>
                        )}
                      />
                    </div>

                    {/* Section 7: Countersign - Available for all certificate types when checkbox is checked */}
                    {navWatchForm.watch('includeCountersign') && (
                      <div className="space-y-4 pt-6 border-t">
                      <h3 className="text-lg font-semibold">Section 7: Countersign</h3>
                      <p className="text-sm text-muted-foreground">
                        If someone is countersigning this application, please provide their details:
                      </p>
                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      <FormField
                        control={navWatchForm.control}
                          name="counterSign.name"
                        render={({ field }) => (
                          <FormItem>
                              <FormLabel>Name</FormLabel>
                            <FormControl>
                                <Input placeholder="Full name" {...field} className="rounded-xl" />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="counterSign.occupation"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Occupation</FormLabel>
                              <FormControl>
                                <Input placeholder="Occupation" {...field} className="rounded-xl" />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                        <FormField
                          control={navWatchForm.control}
                          name="counterSign.addressLine1"
                          render={({ field }) => (
                            <FormItem className="lg:col-span-2">
                              <FormLabel>Address Line 1</FormLabel>
                              <FormControl>
                                <Input placeholder="Street address" {...field} className="rounded-xl" />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="counterSign.addressLine2"
                          render={({ field }) => (
                            <FormItem className="lg:col-span-2">
                              <FormLabel>Address Line 2</FormLabel>
                              <FormControl>
                                <Input placeholder="Apartment, suite, etc." {...field} className="rounded-xl" />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="counterSign.townCity"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Town/City</FormLabel>
                              <FormControl>
                                <Input placeholder="Town or city" {...field} className="rounded-xl" />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="counterSign.countyState"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>County/State</FormLabel>
                              <FormControl>
                                <Input placeholder="County or state" {...field} className="rounded-xl" />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      <FormField
                        control={navWatchForm.control}
                          name="counterSign.postCode"
                        render={({ field }) => (
                            <FormItem>
                              <FormLabel>Post Code</FormLabel>
                            <FormControl>
                                <Input placeholder="Post code" {...field} className="rounded-xl" />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="counterSign.country"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Country</FormLabel>
                              <FormControl>
                                <Input placeholder="Country" {...field} className="rounded-xl" />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                        <FormField
                          control={navWatchForm.control}
                          name="counterSign.telephone"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Telephone</FormLabel>
                              <FormControl>
                                <Input placeholder="Telephone number" {...field} className="rounded-xl" />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="counterSign.capacityKnownApplicant"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Capacity in which known to applicant</FormLabel>
                              <FormControl>
                                <Input placeholder="e.g., Employer, Colleague" {...field} className="rounded-xl" />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        <FormField
                          control={navWatchForm.control}
                          name="counterSign.date"
                          render={({ field }) => (
                            <FormItem className="flex flex-col">
                              <FormLabel>Date</FormLabel>
                              <Popover>
                                <PopoverTrigger asChild>
                                  <FormControl>
                                    <Button
                                      variant="outline"
                                      className={cn(
                                        "w-full pl-3 text-left font-normal rounded-xl",
                                        !field.value && "text-muted-foreground"
                                      )}
                                    >
                                      {field.value ? (
                                        format(parse(field.value, 'dd/MM/yyyy', new Date()), "PPP")
                                      ) : (
                                        <span>Pick a date</span>
                                      )}
                                      <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                                    </Button>
                                  </FormControl>
                                </PopoverTrigger>
                                <PopoverContent className="w-auto p-0" align="start">
                                  <CalendarComponent
                                    mode="single"
                                    selected={field.value ? parse(field.value, 'dd/MM/yyyy', new Date()) : undefined}
                                    onSelect={(date) => field.onChange(date ? format(date, 'dd/MM/yyyy') : undefined)}
                                    disabled={(date) => isAfter(date, startOfDay(new Date()))}
                                    initialFocus
                                  />
                                </PopoverContent>
                              </Popover>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      </div>
                      </div>
                    )}

                    {/* Section 6: Declaration Signature */}
                    <div className="space-y-4 pt-6 border-t">
                      <h3 className="text-lg font-semibold">Section 6: Declaration</h3>
                      <p className="text-sm text-muted-foreground">
                        Please sign this declaration to confirm the information provided is correct:
                      </p>
                      <FormField
                        control={navWatchForm.control}
                        name="signatureDataUrl"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Your Signature *</FormLabel>
                            <FormControl>
                              <div className="border rounded-xl p-4">
                                <SignaturePad
                                  value={field.value}
                                  onChange={field.onChange}
                                  existingSignature={field.value || null}
                                />
                              </div>
                            </FormControl>
                            <FormDescription>
                              Draw or upload your signature for the declaration section
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>

                    <DialogFooter>
                      <Button
                        type="button"
                        variant="outline"
                        onClick={() => setIsNavWatchDialogOpen(false)}
                        disabled={isSaving}
                        className="rounded-xl"
                      >
                        Cancel
                      </Button>
                      <Button
                        type="submit"
                        disabled={isSaving}
                        className="rounded-xl text-white dark:text-white"
                      >
                        {isSaving ? (
                          <>
                            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                            Generating...
                          </>
                        ) : (
                          <>
                            <Download className="mr-2 h-4 w-4" />
                            Generate PDF
                          </>
                        )}
                      </Button>
                    </DialogFooter>
                  </form>
                </Form>
              </DialogContent>
            </Dialog>
          </div>

          {/* Nav Watch Applications Table */}
          <Separator className="my-6" />
          
          {isLoadingNavWatchApplications ? (
            <div className="flex items-center justify-center py-12">
              <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
            </div>
          ) : (
            <Card className="rounded-xl border">
              <CardHeader>
                <CardTitle>Saved Applications</CardTitle>
                <CardDescription>
                  View and download your previously generated MCA Watch Rating Certificate applications.
                </CardDescription>
              </CardHeader>
              <CardContent>
                {navWatchApplications.length === 0 ? (
                  <div className="text-center py-12">
                    <FileText className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
                    <h3 className="text-lg font-semibold mb-2">No Applications Yet</h3>
                    <p className="text-muted-foreground mb-4">
                      Generate your first MCA Watch Rating Certificate application to get started.
                    </p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {navWatchApplications.map((application) => {
                      const certTypeLabels = {
                        navigational: 'Navigational Watch Rating',
                        engine_room: 'Engine Room Watch Rating',
                        electro_technical: 'Electro-Technical Watch Rating',
                      };
                      
                      const totalRecords = Array.isArray(application.sea_service_records) 
                        ? application.sea_service_records.length 
                        : 0;
                      
                      const totalDaysAtSea = Array.isArray(application.sea_service_records)
                        ? application.sea_service_records.reduce((sum, record) => sum + (record.daysAtSea || 0), 0)
                        : 0;

                      return (
                        <Card key={application.id} className="border">
                          <CardContent className="pt-6">
                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                              <div className="flex-1 space-y-2">
                                <div className="flex items-center gap-2">
                                  <Badge variant="outline" className="font-semibold">
                                    {certTypeLabels[application.certificate_type] || application.certificate_type}
                                  </Badge>
                                  <span className="text-sm text-muted-foreground">
                                    {format(new Date(application.created_at), 'PPP')}
                                  </span>
                                </div>
                                <div className="text-sm text-muted-foreground space-y-1">
                                  <div>
                                    <span className="font-medium">Name:</span> {application.personal_details.forenames} {application.personal_details.surname}
                                  </div>
                                  {application.personal_details.dateOfBirth && (
                                    <div>
                                      <span className="font-medium">Date of Birth:</span> {application.personal_details.dateOfBirth}
                                    </div>
                                  )}
                                  <div>
                                    <span className="font-medium">Sea Service Records:</span> {totalRecords} vessel{totalRecords !== 1 ? 's' : ''}  {totalDaysAtSea} days at sea
                                  </div>
                                </div>
                              </div>
                              <div className="flex flex-col sm:flex-row gap-2">
                                <Button
                                  variant="default"
                                  size="sm"
                                  onClick={async () => {
                                    try {
                                      // Merge saved application data with latest profile data (profile takes precedence)
                                      const getProfileField = (snakeCase: string, camelCase: string): string | undefined => {
                                        const value = (userProfile as any)?.[snakeCase] || (userProfile as any)?.[camelCase];
                                        return value && value.trim() ? value.trim() : undefined;
                                      };

                                      const savedPersonalDetails = application.personal_details as any;
                                      const profilePersonalDetails = {
                                        title: getProfileField('title', 'title') || savedPersonalDetails.title,
                                        placeOfBirth: getProfileField('place_of_birth', 'placeOfBirth') || savedPersonalDetails.placeOfBirth,
                                        countryOfBirth: getProfileField('country_of_birth', 'countryOfBirth') || savedPersonalDetails.countryOfBirth,
                                        nationality: getProfileField('nationality', 'nationality') || savedPersonalDetails.nationality,
                                        telephone: getProfileField('telephone', 'telephone') || savedPersonalDetails.telephone,
                                        mobile: getProfileField('mobile', 'mobile') || savedPersonalDetails.mobile,
                                        address: {
                                          line1: getProfileField('address_line1', 'addressLine1') || savedPersonalDetails.address?.line1 || '',
                                          line2: getProfileField('address_line2', 'addressLine2') || savedPersonalDetails.address?.line2,
                                          district: getProfileField('address_district', 'addressDistrict') || savedPersonalDetails.address?.district,
                                          townCity: getProfileField('address_town_city', 'addressTownCity') || savedPersonalDetails.address?.townCity || '',
                                          countyState: getProfileField('address_county_state', 'addressCountyState') || savedPersonalDetails.address?.countyState,
                                          postCode: getProfileField('address_post_code', 'addressPostCode') || savedPersonalDetails.address?.postCode || '',
                                          country: getProfileField('address_country', 'addressCountry') || savedPersonalDetails.address?.country || '',
                                        },
                                      };

                                      await generateMCAWatchRatingForm({
                                        personalDetails: {
                                          ...savedPersonalDetails,
                                          ...profilePersonalDetails,
                                          dateOfBirth: savedPersonalDetails.dateOfBirth || '',
                                        },
                                        certificateType: application.certificate_type,
                                        seaServiceRecords: Array.isArray(application.sea_service_records) 
                                          ? application.sea_service_records 
                                          : [],
                                        userProfile: {
                                          firstName: userProfile?.firstName,
                                          lastName: userProfile?.lastName,
                                          username: userProfile?.username || '',
                                          email: userProfile?.email || '',
                                          dateOfBirth: (userProfile as any)?.dateOfBirth || null,
                                          position: userProfile?.position || null,
                                          dischargeBookNumber: userProfile?.dischargeBookNumber || null,
                                        },
                                      }, 'download', { debug: false });
                                      
                                      toast({
                                        title: 'Success',
                                        description: 'Official Form PDF downloaded successfully.',
                                      });
                                    } catch (error: any) {
                                      console.error('Error generating PDF:', error);
                                      toast({
                                        title: 'Error',
                                        description: error.message || 'Failed to generate PDF. Please try again.',
                                        variant: 'destructive',
                                      });
                                    }
                                  }}
                                  className="rounded-xl text-white dark:text-white"
                                >
                                  <Download className="mr-2 h-4 w-4" />
                                  Download PDF
                                </Button>
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  onClick={() => setApplicationToDelete(application)}
                                  className="rounded-xl text-destructive hover:text-destructive hover:bg-destructive/10"
                                >
                                  <Trash2 className="h-4 w-4" />
                                </Button>
                              </div>
                            </div>
                          </CardContent>
                        </Card>
                      );
                    })}
                  </div>
                )}
              </CardContent>
            </Card>
          )}
        </>
      )}

      {/* Other Document Types - Coming Soon Placeholders */}
      {documentType !== 'testimonial' && documentType !== 'nav_watch_application' && documentType !== 'oow' && (
        <Card>
          <CardContent className="pt-6">
            <div className="flex flex-col items-center justify-center py-12 text-center">
              <div className="h-16 w-16 rounded-full bg-muted flex items-center justify-center mb-4">
                <DocumentIcon className="h-8 w-8 text-muted-foreground" />
              </div>
              <h3 className="text-xl font-semibold mb-2">{currentDocumentType.label} Coming Soon</h3>
              <p className="text-muted-foreground max-w-md">
                We're working on adding support for {currentDocumentType.label.toLowerCase()} documents. 
                For now, please use the Testimonials feature to generate your sea service documents.
              </p>
              <Button
                variant="outline"
                className="mt-6 rounded-xl"
                onClick={() => setDocumentType('testimonial')}
              >
                <FileText className="mr-2 h-4 w-4" />
                Use Testimonials Instead
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Delete Confirmation Dialog */}
      <AlertDialog 
        open={!!testimonialToDelete} 
        onOpenChange={(open) => {
          // Prevent closing during password verification or deletion
          if (!open && (isVerifyingPassword || isDeleting || isVerifyingRef.current)) {
            // Force dialog to stay open by preventing state change
            return;
          }
          if (!open) {
            setTestimonialToDelete(null);
            setDeletePassword('');
            setPasswordError('');
            isVerifyingRef.current = false;
          }
        }}
      >
        {/* Delete Application Dialog */}
        <AlertDialog open={!!applicationToDelete} onOpenChange={(open) => !open && setApplicationToDelete(null)}>
          <AlertDialogContent className="rounded-xl max-w-xl">
            <AlertDialogHeader>
              <AlertDialogTitle className="flex items-center gap-2">
                <Trash2 className="h-5 w-5 text-destructive" />
                Delete Application?
              </AlertDialogTitle>
              {applicationToDelete && (
                <AlertDialogDescription>
                  Are you sure you want to delete this application? This action cannot be undone. 
                  You can always generate a new application with your current data.
                </AlertDialogDescription>
              )}
            </AlertDialogHeader>
            {applicationToDelete && (
              <div className="space-y-3 pt-2">
                <div>
                  <span className="font-medium text-sm">
                    {applicationToDelete.personal_details.forenames} {applicationToDelete.personal_details.surname} - {
                      applicationToDelete.certificate_type === 'navigational' ? 'Navigational Watch Rating' :
                      applicationToDelete.certificate_type === 'engine_room' ? 'Engine Room Watch Rating' :
                      applicationToDelete.certificate_type === 'electro_technical' ? 'Electro-Technical Watch Rating' :
                      applicationToDelete.certificate_type
                    }
                  </span>
                  <div className="text-sm text-muted-foreground mt-1">
                    Created: {format(new Date(applicationToDelete.created_at), 'PPP')}
                  </div>
                </div>
              </div>
            )}
            <AlertDialogFooter>
              <AlertDialogCancel className="rounded-xl">Cancel</AlertDialogCancel>
              <AlertDialogAction
                onClick={() => applicationToDelete && handleDeleteApplication(applicationToDelete)}
                disabled={isDeletingApplication}
                className="rounded-xl bg-destructive hover:bg-destructive/90"
              >
                {isDeletingApplication ? (
                  <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Deleting...
                  </>
                ) : (
                  <>
                    <Trash2 className="mr-2 h-4 w-4" />
                    Delete
                  </>
                )}
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        <AlertDialogContent className="rounded-xl max-w-xl">
          <AlertDialogHeader>
            <AlertDialogTitle className="flex items-center gap-2">
              <Trash2 className="h-5 w-5 text-destructive" />
              Delete Testimonial?
            </AlertDialogTitle>
            {testimonialToDelete && (
              <AlertDialogDescription>
                {testimonialToDelete.status === 'approved' 
                  ? 'This approved testimonial will be permanently deleted. You will need to request it again and have it signed off again.'
                  : 'Are you sure you want to delete this testimonial? This action cannot be undone.'}
              </AlertDialogDescription>
            )}
          </AlertDialogHeader>
          {testimonialToDelete && (
            <div className="space-y-3 pt-2">
              <div>
                <span className="font-medium text-sm">
                  {getVesselName(testimonialToDelete.vessel_id)} - {format(new Date(testimonialToDelete.start_date), 'MMM d, yyyy')} to {format(new Date(testimonialToDelete.end_date), 'MMM d, yyyy')}
                </span>
              </div>
              
              {testimonialToDelete.status === 'approved' && (
                <>
                  <div className="bg-yellow-50 dark:bg-yellow-950/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3 space-y-2">
                    <div className="flex items-start gap-2">
                      <AlertCircle className="h-4 w-4 text-yellow-600 dark:text-yellow-400 mt-0.5 flex-shrink-0" />
                      <div className="text-sm text-yellow-900 dark:text-yellow-100 space-y-1">
                        <p className="font-semibold">Warning: This testimonial is approved</p>
                        <p>If you delete this approved testimonial:</p>
                        <ul className="list-disc list-inside space-y-1 ml-2">
                          <li>You will need to request it again</li>
                          <li>You will need to have it signed off again by the captain</li>
                          <li>This action cannot be undone</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  
                  <div className="space-y-2 pt-2">
                    <Label htmlFor="delete-password" className="text-sm font-medium">
                      Confirm your password to delete
                    </Label>
                    <Input
                      id="delete-password"
                      type="password"
                      placeholder="Enter your password"
                      value={deletePassword}
                      onChange={(e) => {
                        setDeletePassword(e.target.value);
                        setPasswordError('');
                      }}
                      className={cn(
                        "rounded-lg",
                        passwordError && "border-destructive"
                      )}
                      disabled={isVerifyingPassword || isDeleting}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' && deletePassword && !isVerifyingPassword && !isDeleting) {
                          verifyPasswordAndDelete(testimonialToDelete);
                        }
                      }}
                    />
                    {passwordError && (
                      <p className="text-sm text-destructive">{passwordError}</p>
                    )}
                  </div>
                </>
              )}
            </div>
          )}
          <AlertDialogFooter>
            <AlertDialogCancel 
              disabled={isDeleting || isVerifyingPassword} 
              className="rounded-xl"
              onClick={() => {
                setDeletePassword('');
                setPasswordError('');
              }}
            >
              Cancel
            </AlertDialogCancel>
            <AlertDialogAction
              onClick={() => {
                if (testimonialToDelete) {
                  if (testimonialToDelete.status === 'approved') {
                    verifyPasswordAndDelete(testimonialToDelete);
                  } else {
                    handleDeleteTestimonial(testimonialToDelete);
                  }
                }
              }}
              disabled={isDeleting || isVerifyingPassword || (testimonialToDelete?.status === 'approved' && !deletePassword)}
              className="rounded-xl bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              {isDeleting || isVerifyingPassword ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  {isVerifyingPassword ? 'Verifying...' : 'Deleting...'}
                </>
              ) : (
                <>
                  <Trash2 className="mr-2 h-4 w-4" />
                  Delete Permanently
                </>
              )}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}
